#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { GoogleGenerativeAI } = require('@google/generative-ai');

// –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
const [category, slug, title] = process.argv.slice(2);

if (!category || !slug || !title) {
  console.error('Usage: node generate-lesson.js <category> <slug> "Title"');
  console.error('Example: node generate-lesson.js typescript conditional-types "–£—Å–ª–æ–≤–Ω—ã–µ —Ç–∏–ø—ã"');
  process.exit(1);
}

const apiKey = process.env.GOOGLE_GEMINI_API_KEY;
if (!apiKey) {
  console.error('Error: GOOGLE_GEMINI_API_KEY environment variable not set');
  process.exit(1);
}

const genAI = new GoogleGenerativeAI(apiKey);

const SYSTEM_PROMPTS = {
  html: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ HTML, —Å–æ–∑–¥–∞—é—â–∏–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤ —Å—Ç–∏–ª–µ "Yasha Learn Code".

–°–¢–ò–õ–¨:
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π
- –ü—Ä–∞–∫—Ç–∏—á–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: —Ç–µ–æ—Ä–∏—è ‚Üí –ø—Ä–∏–º–µ—Ä—ã ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞

–§–û–†–ú–ê–¢ MDX:
- –ù–∞—á–Ω–∏ —Å H2 –∑–∞–≥–æ–ª–æ–≤–∫–∞: ## HTML: [–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã]
- –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π H3 (###)
- –ë–ª–æ–∫–∏ –∫–æ–¥–∞: \`\`\`html
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –í –∫–æ–Ω—Ü–µ: "### üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞" —Å –∑–∞–¥–∞–Ω–∏—è–º–∏
- –ò —Ä–∞–∑–¥–µ–ª "### üí° –°–æ–≤–µ—Ç"

–°–¢–†–£–ö–¢–£–†–ê:
1. –ß—Ç–æ —ç—Ç–æ –∏ –∑–∞—á–µ–º
2. –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–æ—Ä–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
3. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã
4. –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
5. –ü—Ä–∞–∫—Ç–∏–∫–∞ (3-5 –∑–∞–¥–∞–Ω–∏–π)
6. –°–æ–≤–µ—Ç/–∑–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–ª–∏–Ω–∞: 80-120 —Å—Ç—Ä–æ–∫. –ú–∏–Ω–∏–º—É–º 5 –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π HTML5.`,
  
  css: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ CSS, —Å–æ–∑–¥–∞—é—â–∏–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–°–¢–ò–õ–¨: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π, —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏.

–§–û–†–ú–ê–¢ MDX:
- H2: ## CSS: [–ù–∞–∑–≤–∞–Ω–∏–µ]
- H3 –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏
- –ë–ª–æ–∫–∏ –∫–æ–¥–∞: \`\`\`css
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –í –∫–æ–Ω—Ü–µ: "### üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞" –∏ "### üí° –°–æ–≤–µ—Ç"

–°–¢–†–£–ö–¢–£–†–ê: —Ç–µ–æ—Ä–∏—è ‚Üí –ø—Ä–∏–º–µ—Ä—ã ‚Üí —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞ ‚Üí —Å–æ–≤–µ—Ç

–î–ª–∏–Ω–∞: 80-120 —Å—Ç—Ä–æ–∫. –ú–∏–Ω–∏–º—É–º 5-7 –ø—Ä–∏–º–µ—Ä–æ–≤. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π CSS (Grid, Flexbox, Custom Properties).`,

  javascript: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ JavaScript, —Å–æ–∑–¥–∞—é—â–∏–π –∫—É—Ä—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–°–¢–ò–õ–¨: –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π JS (ES6+), –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π, —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏.

–§–û–†–ú–ê–¢ MDX:
- H2: ## JavaScript: [–ù–∞–∑–≤–∞–Ω–∏–µ]
- –ë–ª–æ–∫–∏ –∫–æ–¥–∞: \`\`\`javascript
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –ü—Ä–∞–∫—Ç–∏–∫–∞ –∏ —Å–æ–≤–µ—Ç—ã –≤ –∫–æ–Ω—Ü–µ

–°–¢–†–£–ö–¢–£–†–ê: –∫–æ–Ω—Ü–µ–ø—Ü–∏—è ‚Üí –ø—Ä–∏–º–µ—Ä—ã ‚Üí –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‚Üí —Ç–∏–ø–∏—á–Ω—ã–µ –±–∞–≥–∏ ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞

–î–ª–∏–Ω–∞: 100-130 —Å—Ç—Ä–æ–∫. –ú–∏–Ω–∏–º—É–º 6-8 –ø—Ä–∏–º–µ—Ä–æ–≤. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (async/await, destructuring, spread).`,

  typescript: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ TypeScript, —Å–æ–∑–¥–∞—é—â–∏–π –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∫—É—Ä—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–°–¢–ò–õ–¨: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ+ —É—Ä–æ–≤–Ω—è. –ü–æ–∫–∞–∑—ã–≤–∞–π —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ best practices.

–§–û–†–ú–ê–¢ MDX:
- H2: ## TypeScript: [–ù–∞–∑–≤–∞–Ω–∏–µ]
- –ë–ª–æ–∫–∏ –∫–æ–¥–∞: \`\`\`typescript
- –ü—Ä–∏–º–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∏–ª—É —Ç–∏–ø–æ–≤

–°–¢–†–£–ö–¢–£–†–ê: –ø—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ —Ç–∏–ø–æ–≤ ‚Üí —Ä–µ—à–µ–Ω–∏–µ —Å TypeScript ‚Üí –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞

–î–ª–∏–Ω–∞: 100-140 —Å—Ç—Ä–æ–∫. –ú–∏–Ω–∏–º—É–º 6-8 –ø—Ä–∏–º–µ—Ä–æ–≤. TypeScript 5.x.`,

  react: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ React, —Å–æ–∑–¥–∞—é—â–∏–π –∫—É—Ä—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–°–¢–ò–õ–¨: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, hooks, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π React.

–§–û–†–ú–ê–¢ MDX:
- H2: ## React: [–ù–∞–∑–≤–∞–Ω–∏–µ]
- –ë–ª–æ–∫–∏ –∫–æ–¥–∞: \`\`\`jsx –∏–ª–∏ \`\`\`typescript (–¥–ª—è TSX)
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º

–°–¢–†–£–ö–¢–£–†–ê: –∫–æ–Ω—Ü–µ–ø—Ü–∏—è ‚Üí –±–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä ‚Üí hooks ‚Üí –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è ‚Üí —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞

–î–ª–∏–Ω–∞: 100-140 —Å—Ç—Ä–æ–∫. –ú–∏–Ω–∏–º—É–º 5-7 –ø—Ä–∏–º–µ—Ä–æ–≤. React 18+.`,

  git: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Git, —Å–æ–∑–¥–∞—é—â–∏–π –∫—É—Ä—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–°–¢–ò–õ–¨: –ü—Ä–∞–∫—Ç–∏—á–Ω—ã–π, —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ —Å—Ö–µ–º–∞–º–∏ (ASCII).

–§–û–†–ú–ê–¢ MDX:
- H2: ## Git: [–ù–∞–∑–≤–∞–Ω–∏–µ]
- –ë–ª–æ–∫–∏ –∫–æ–¥–∞: \`\`\`bash
- –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- –ü–æ—è—Å–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π –∫–æ–º–∞–Ω–¥

–°–¢–†–£–ö–¢–£–†–ê: –∑–∞–¥–∞—á–∞ ‚Üí –∫–æ–º–∞–Ω–¥—ã ‚Üí –ø—Ä–∏–º–µ—Ä—ã ‚Üí —Ç–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞

–î–ª–∏–Ω–∞: 80-110 —Å—Ç—Ä–æ–∫. –ú–∏–Ω–∏–º—É–º 5-6 –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–º–∞–Ω–¥. Git best practices.`
};

async function generateLesson() {
  console.log(`\nüîß –ì–µ–Ω–µ—Ä–∏—Ä—É—é —É—Ä–æ–∫: ${title}`);
  console.log(`üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}, slug: ${slug}\n`);

  try {
    const systemPrompt = SYSTEM_PROMPTS[category] || SYSTEM_PROMPTS.html;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å
    const model = genAI.getGenerativeModel({ 
      model: 'gemini-2.5-flash',
      systemInstruction: systemPrompt
    });

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    const prompt = `–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ –Ω–∞ —Ç–µ–º—É: "${title}".
    
–ì–µ–Ω–µ—Ä–∏—Ä—É–π MDX –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é, –Ω–∞—á–∏–Ω–∞—è —Å ## –∑–∞–≥–æ–ª–æ–≤–∫–∞.`;

    console.log('‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ Gemini API...');
    const result = await model.generateContent(prompt);
    const response = result.response;
    const content = response.text();

    // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —É—Ä–æ–∫–∞
    const lessonDir = path.join(process.cwd(), 'pages', category);
    const lessonPath = path.join(lessonDir, `${slug}.mdx`);

    // –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!fs.existsSync(lessonDir)) {
      fs.mkdirSync(lessonDir, { recursive: true });
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª
    fs.writeFileSync(lessonPath, content, 'utf8');
    console.log(`‚úÖ –£—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω: ${lessonPath}`);

    // –û–±–Ω–æ–≤–ª—è–µ–º _meta.json
    updateMetaJson(category, slug, title);

    console.log('‚ú® –ì–æ—Ç–æ–≤–æ!\n');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error.message);
    process.exit(1);
  }
}

function updateMetaJson(category, slug, title) {
  const metaPath = path.join(process.cwd(), 'pages', category, '_meta.json');
  
  let meta = {};
  if (fs.existsSync(metaPath)) {
    meta = JSON.parse(fs.readFileSync(metaPath, 'utf8'));
  }

  // Check if slug already exists to preserve numbering or use a new one
  if (!meta[slug]) {
    const existingNumbers = Object.values(meta)
      .map(val => {
        const match = val.match(/^(\d+)\./);
        return match ? parseInt(match[1]) : 0;
      })
      .filter(num => num > 0);

    const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
    meta[slug] = `${nextNumber}. ${title}`;
  } else {
    // Keep existing number if just regenerating content
    const match = meta[slug].match(/^(\d+)\./);
    const num = match ? match[1] : '0';
    meta[slug] = `${num}. ${title}`;
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π _meta.json
  fs.writeFileSync(metaPath, JSON.stringify(meta, null, 2) + '\n', 'utf8');
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
generateLesson();
