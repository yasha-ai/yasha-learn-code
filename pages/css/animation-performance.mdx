## CSS: Производительность анимаций (will-change, GPU)


![Иллюстрация к уроку](/lessons/css-animation-performance.png)
Анимации делают веб-сайты более привлекательными, но неправильная их реализация может существенно снизить производительность. В этом уроке мы рассмотрим, как оптимизировать CSS-анимации, используя свойство `will-change` и задействуя графический процессор (GPU).

### Проблема производительности

Когда браузер анимирует элемент, ему приходится пересчитывать стили и перерисовывать его на каждом кадре анимации. Это может быть ресурсоемким процессом, особенно если анимируется сложное свойство или большое количество элементов. Без оптимизации, анимация может стать "дерганой" и неприятной для пользователя.

### `will-change`: Подсказка для браузера

Свойство `will-change` позволяет сообщить браузеру, какие свойства элемента будут анимироваться. Это дает браузеру возможность заранее подготовиться к изменениям и оптимизировать процесс анимации.

Пример:

```css
.element {
  transition: transform 0.3s ease-in-out;
}

.element:hover {
  transform: translateX(100px);
}

.element:hover {
  will-change: transform; /* Сообщаем браузеру, что будет изменяться transform */
}
```

В этом примере, при наведении на элемент `.element`, он будет смещаться вправо. Добавление `will-change: transform;` позволяет браузеру заранее выделить необходимые ресурсы для плавной анимации `transform`.

**Важно:** Не злоупотребляйте `will-change`. Используйте его только для элементов, которые действительно анимируются. Чрезмерное использование может привести к повышенному потреблению памяти и даже ухудшению производительности.

### GPU: Аппаратное ускорение

Современные браузеры используют графический процессор (GPU) для ускорения определенных операций, включая CSS-анимации. Однако, не все CSS-свойства могут быть ускорены GPU.

Свойства, которые обычно ускоряются GPU:

*   `transform` (translate, rotate, scale)
*   `opacity`

Использование этих свойств для анимации, как правило, обеспечивает более плавную и производительную анимацию, чем, например, анимация `top`, `left`, `width` или `height`.

Пример:

```css
.element {
  transition: transform 0.3s ease-in-out;
}

.element:hover {
  transform: translateX(100px) rotate(45deg); /* Используем transform для анимации */
}
```

Вместо изменения `left` или `top` для перемещения элемента, мы используем `translateX`. Это позволяет браузеру задействовать GPU для анимации, что значительно повышает производительность.

### Жизненный пример

Многие современные веб-сайты и фреймворки активно используют `will-change` и GPU-ускоренные свойства для создания плавных и интерактивных пользовательских интерфейсов.

Например, при создании параллакс-эффекта (когда фон движется с другой скоростью, чем основной контент), часто используют `transform: translateZ(0)` в сочетании с `will-change: transform` для плавного перемещения фоновых изображений. Библиотеки анимаций, такие как GreenSock (GSAP), также активно используют эти методы для оптимизации производительности анимаций.

React и Vue.js фреймворки могут динамически добавлять и удалять классы, содержащие `will-change`, в зависимости от состояния компонента, чтобы оптимизировать рендеринг.

### Ключевые моменты

*   `will-change` подсказывает браузеру, какие свойства будут анимироваться.
*   Используйте `will-change` только для анимируемых элементов.
*   `transform` и `opacity` обычно ускоряются GPU.
*   Избегайте анимации свойств, которые не ускоряются GPU (например, `top`, `left`).
*   Используйте инструменты разработчика браузера для анализа производительности анимаций.
*   Тестируйте анимации на разных устройствах и браузерах.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSS Animation Performance</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>CSS Animation Performance</h1>

    <div class="box-container">
      <div id="box1" class="box">Box 1 (No will-change)</div>
      <div id="box2" class="box">Box 2 (will-change)</div>
    </div>

    <div class="controls">
      <button id="animateButton">Animate Boxes</button>
    </div>

    <p>Инструкция: Нажмите кнопку "Animate Boxes", чтобы увидеть разницу в производительности между двумя блоками. Box 2 использует <code>will-change</code> для оптимизации анимации.</p>
  </div>

  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
  padding: 20px;
}

.container {
  text-align: center;
}

.box-container {
  display: flex;
  justify-content: space-around;
  margin-bottom: 20px;
}

.box {
  width: 150px;
  height: 150px;
  background-color: #4CAF50;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: transform 0.5s ease-in-out;
  border-radius: 8px;
}

#box2 {
  will-change: transform; /* Оптимизация анимации */
}

.box.animate {
  transform: translateX(100px) rotate(180deg);
}

.controls button {
  background-color: #008CBA;
  color: white;
  padding: 10px 20px;
  border: none;
  cursor: pointer;
  border-radius: 5px;
}

.controls button:hover {
  background-color: #005f6b;
}
`,
    "/index.js": `document.addEventListener('DOMContentLoaded', () => {
  const box1 = document.getElementById('box1');
  const box2 = document.getElementById('box2');
  const animateButton = document.getElementById('animateButton');

  animateButton.addEventListener('click', () => {
    // Добавляем класс для запуска анимации
    box1.classList.add('animate');
    box2.classList.add('animate');

    // Убираем класс после завершения анимации
    setTimeout(() => {
      box1.classList.remove('animate');
      box2.classList.remove('animate');
    }, 500); // Время анимации (0.5s)
  });
});
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
