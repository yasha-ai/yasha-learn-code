## Git: Разрешение конфликтов

### Задача

Понять, что такое конфликты слияния (merge conflicts), почему они возникают и как эффективно разрешать их, чтобы успешно интегрировать изменения из разных веток и поддерживать целостность истории проекта.

### Когда возникают конфликты?

Конфликты возникают, когда Git не может автоматически объединить изменения из двух разных веток, поскольку они затрагивают одни и те же строки в одном и том же файле, или когда один файл был изменен в одной ветке и удален в другой. Чаще всего это происходит при:

*   `git merge`
*   `git rebase`
*   `git pull` (так как он выполняет `git fetch` и `git merge`)

### Основные шаги по разрешению конфликтов

1.  **Обнаружение:** Git сообщает о конфликте.
2.  **Идентификация:** Выяснить, какие файлы и строки конфликтуют.
3.  **Редактирование:** Вручную изменить конфликтные файлы, выбрав нужные изменения.
4.  **Разрешение:** Отметить файл как разрешенный (`git add`).
5.  **Завершение:** Закоммитить слияние (`git commit`).

### Команды и их назначение

*   `git status`: Показывает текущее состояние репозитория, включая файлы с конфликтами.
*   `git diff`: Показывает различия между коммитами, а в случае конфликта – конфликтные маркеры.
*   `git log --merge`: Помогает понять, какие коммиты участвуют в конфликте.
*   `git add <file>`: После ручного разрешения конфликта в файле, эта команда отмечает файл как "разрешенный".
*   `git commit`: Завершает слияние, создавая новый коммит слияния.
*   `git merge --abort`: Отменяет операцию слияния, если вы решили, что не хотите ее продолжать.
*   `git rebase --abort`: Отменяет операцию rebase.
*   `git mergetool`: Запускает внешний графический инструмент для разрешения конфликтов (например, Kdiff3, Meld, Sublime Merge).

### Пример разрешения конфликта

Представим, что у нас есть файл `README.md`, и две ветки одновременно изменили одну и ту же строку.

1.  **Начальная настройка:**
    ```bash
    git init myproject
    cd myproject
    echo "Привет, мир!" > README.md
    git add README.md
    git commit -m "Initial commit"
    # Создаем ветку feature и переключаемся на нее
    git checkout -b feature
    ```

2.  **Изменение в ветке `feature`:**
    ```bash
    echo "Привет, Вселенная!" > README.md
    git add README.md
    git commit -m "Изменили приветствие в feature"
    ```

3.  **Изменение в ветке `main` (конфликтный сценарий):**
    ```bash
    git checkout main
    echo "Привет, планета!" > README.md
    git add README.md
    git commit -m "Изменили приветствие в main"
    ```

4.  **Попытка слияния (возникновение конфликта):**
    ```bash
    git merge feature
    ```
    Результат: Git сообщит о конфликте в `README.md`.
    ```
    Auto-merging README.md
    CONFLICT (content): Merge conflict in README.md
    Automatic merge failed; fix conflicts and then commit the result.
    ```

5.  **Идентификация конфликта:**
    ```bash
    git status
    # Output:
    # On branch main
    # You have unmerged paths.
    #   (fix conflicts and run "git commit")
    #   (use "git merge --abort" to abandon merge)
    #
    # Unmerged paths:
    #   (use "git add <file>..." to mark resolution)
    #         both modified: README.md
    #
    # no changes added to commit (use "git add" and/or "git commit -a)")
    ```
    Откроем `README.md` в текстовом редакторе:
    ```
    <<<<<<< HEAD
    Привет, планета!
    =======
    Привет, Вселенная!
    >>>>>>> feature
    ```
    *   `<<<<<<< HEAD`: Начало изменений из текущей ветки (`main`).
    *   `=======`: Разделитель между версиями.
    *   `>>>>>>> feature`: Конец изменений из сливаемой ветки (`feature`).

6.  **Ручное разрешение:**
    Выбираем, какую версию оставить (или комбинируем). Например, оставляем "Привет, Вселенная!".
    ```
    Привет, Вселенная!
    ```

7.  **Отметка о разрешении и завершение слияния:**
    ```bash
    git add README.md
    git commit -m "Merge branch 'feature' into main - resolved conflict"
    ```
    Git откроет редактор для сообщения коммита слияния. Сохраните его.

### Типичные проблемы и лучшие практики

*   **Забыли `git add`:** Git будет считать файл конфликтующим, пока вы не добавите его в индекс после редактирования.
*   **Закоммитили маркеры конфликтов:** Всегда проверяйте файлы перед `git add`, чтобы убедиться, что маркеры `<<<<<<<`, `=======`, `>>>>>>>` удалены.
*   **Не паникуйте!** Git всегда сохраняет исходные версии, и вы можете отменить слияние с помощью `git merge --abort`.
*   **Best Practice:**
    *   **Часто сливайте/ребейзите:** Чем чаще вы интегрируете изменения, тем меньше будут конфликты.
    *   **Понимайте контекст:** Не просто удаляйте маркеры, а понимайте, что делают изменения в обеих ветках.
    *   **Используйте `git mergetool`:** Для сложных конфликтов графические инструменты значительно облегчают работу.

### Практика

Повторите описанный выше сценарий. Затем попробуйте создать конфликт, когда одна ветка удаляет файл, а другая его меняет. Используйте `git merge --abort`, чтобы отменить слияние, если что-то пойдет не так.