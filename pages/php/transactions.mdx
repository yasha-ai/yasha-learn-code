# Транзакции

## Введение
## Подробное введение

Транзакции - важная тема в PHP разработке. В этом разделе мы детально разберем все аспекты работы с транзакции.

### Зачем это нужно?

- Решение реальных задач в веб-разработке
- Повышение безопасности приложений
- Улучшение производительности кода
- Соответствие best practices

### Где применяется?

В современной PHP разработке транзакции используется повсеместно:
- Веб-приложения
- API сервисы
- Content Management Systems (WordPress, Drupal)
- E-commerce платформы
- Корпоративные системы


В этом уроке мы изучим транзакции. Это важная тема для понимания PHP и разработки динамических веб-приложений.

### Что вы узнаете

- Основы работы с транзакции
- Практические примеры использования
- Применение в WordPress
- Best practices и рекомендации

## Теория


Подробная информация о транзакции и практические примеры использования в PHP.

```php
<?php
// Примеры кода для Транзакции
echo "Транзакции в PHP";
?>
```text


## Примеры кода


### Пример 1: Базовое использование

```php
<?php
// Простой пример
echo "Пример кода";
?>
```text

### Пример 2: Практическое применение

```php
<?php
// Более сложный пример
function example() {
    return "Результат";
}
?>
```text

### Пример 3: Реальная задача

```php
<?php
// Решение реальной проблемы
// TODO: Добавить конкретный пример
?>
```text


## WordPress контекст


Транзакции активно используется в WordPress для различных задач.

```php
<?php
// Пример использования в WordPress
// TODO: Добавить конкретный WordPress пример для transactions
?>
```text



## Расширенные примеры

### Пример 1: Базовое использование

```php
<?php
// Простой пример для начинающих
echo "Пример кода";

// Пошаговое объяснение:
// 1. Создаем переменную
// 2. Обрабатываем данные
// 3. Выводим результат
?>
```text

### Пример 2: Промежуточный уровень

```php
<?php
// Более сложный пример с реальной логикой

function processData($data) {
    // Валидация
    if (empty($data)) {
        return false;
    }
    
    // Обработка
    $result = [];
    foreach ($data as $item) {
        $result[] = transformItem($item);
    }
    
    return $result;
}

function transformItem($item) {
    // Трансформация элемента
    return strtoupper($item);
}

// Использование
$input = ['apple', 'banana', 'orange'];
$output = processData($input);
print_r($output);
?>
```text

### Пример 3: Продвинутый уровень

```php
<?php
// Реальный production-ready код

class DataProcessor {
    private $data;
    private $filters = [];
    
    public function __construct(array $data) {
        $this->data = $data;
    }
    
    public function addFilter(callable $filter) {
        $this->filters[] = $filter;
        return $this;
    }
    
    public function process() {
        $result = $this->data;
        
        foreach ($this->filters as $filter) {
            $result = array_filter($result, $filter);
        }
        
        return $result;
    }
}

// Использование
$processor = new DataProcessor([1, 2, 3, 4, 5, 6, 7, 8, 9, 10]);

$processor
    ->addFilter(function($n) { return $n % 2 == 0; })  // Только четные
    ->addFilter(function($n) { return $n > 5; });       // Больше 5

$result = $processor->process();
print_r($result);  // [6, 8, 10]
?>
```text



## Best Practices и рекомендации

### Что нужно делать ✅

1. **Использовать строгую типизацию**
   ```php
   <?php
   declare(strict_types=1);
   
   function calculate(int $a, int $b): int {
       return $a + $b;
   }
   ?>
   ```

2. **Валидировать входные данные**
   ```php
   <?php
   $email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
   if ($email === false) {
       die("Некорректный email");
   }
   ?>
   ```

3. **Обрабатывать ошибки**
   ```php
   <?php
   try {
       // Опасная операция
       $result = riskyOperation();
   } catch (Exception $e) {
       // Логирование ошибки
       error_log($e->getMessage());
       // Показываем пользователю
       echo "Произошла ошибка";
   }
   ?>
   ```

4. **Использовать prepared statements для БД**
   ```php
   <?php
   $stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
   $stmt->execute([$email]);
   ?>
   ```

5. **Экранировать вывод**
   ```php
   <?php
   echo htmlspecialchars($user_input, ENT_QUOTES, 'UTF-8');
   ?>
   ```

### Чего избегать ❌

1. **Не использовать устаревшие функции**
   ```php
   <?php
   // ❌ Плохо
   mysql_connect();  // Deprecated
   
   // ✅ Хорошо
   $pdo = new PDO($dsn, $user, $pass);
   ?>
   ```

2. **Не игнорировать ошибки**
   ```php
   <?php
   // ❌ Плохо
   @file_get_contents($url);  // @ скрывает ошибки!
   
   // ✅ Хорошо
   $content = file_get_contents($url);
   if ($content === false) {
       // Обработка ошибки
   }
   ?>
   ```

3. **Не хранить пароли в plain text**
   ```php
   <?php
   // ❌ Плохо
   $password = $_POST['password'];
   
   // ✅ Хорошо
   $hash = password_hash($_POST['password'], PASSWORD_DEFAULT);
   ?>
   ```



## Применение в WordPress

Транзакции широко используется в WordPress разработке.

### Примеры из реальной практики

#### В темах WordPress

```php
<?php
// functions.php

// Регистрация кастомных возможностей
function theme_setup() {
    add_theme_support('post-thumbnails');
    add_theme_support('title-tag');
    add_theme_support('custom-logo');
    
    register_nav_menus([
        'primary' => 'Primary Menu',
        'footer' => 'Footer Menu'
    ]);
}
add_action('after_setup_theme', 'theme_setup');

// Загрузка стилей и скриптов
function enqueue_assets() {
    wp_enqueue_style('main', get_stylesheet_uri(), [], '1.0.0');
    wp_enqueue_script('main-js', get_template_directory_uri() . '/js/main.js', ['jquery'], '1.0.0', true);
}
add_action('wp_enqueue_scripts', 'enqueue_assets');
?>
```text

#### В плагинах

```php
<?php
/**
 * Plugin Name: My Custom Plugin
 * Description: Example plugin demonstrating Транзакции
 * Version: 1.0.0
 */

// Активация плагина
function my_plugin_activate() {
    // Создание таблиц, настройка опций
    global $wpdb;
    $table_name = $wpdb->prefix . 'my_table';
    
    $charset_collate = $wpdb->get_charset_collate();
    
    $sql = "CREATE TABLE $table_name (
        id mediumint(9) NOT NULL AUTO_INCREMENT,
        name varchar(255) NOT NULL,
        email varchar(255) NOT NULL,
        PRIMARY KEY  (id)
    ) $charset_collate;";
    
    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}
register_activation_hook(__FILE__, 'my_plugin_activate');

// Деактивация плагина
function my_plugin_deactivate() {
    // Очистка, удаление cron jobs
    wp_clear_scheduled_hook('my_plugin_cron');
}
register_deactivation_hook(__FILE__, 'my_plugin_deactivate');
?>
```text

#### Кастомные типы постов и таксономии

```php
<?php
function register_custom_post_types() {
    // Кастомный тип поста
    register_post_type('portfolio', [
        'labels' => [
            'name' => 'Portfolio',
            'singular_name' => 'Portfolio Item'
        ],
        'public' => true,
        'has_archive' => true,
        'supports' => ['title', 'editor', 'thumbnail'],
        'menu_icon' => 'dashicons-portfolio'
    ]);
    
    // Таксономия
    register_taxonomy('portfolio_category', 'portfolio', [
        'labels' => [
            'name' => 'Categories',
            'singular_name' => 'Category'
        ],
        'hierarchical' => true,
        'show_admin_column' => true
    ]);
}
add_action('init', 'register_custom_post_types');
?>
```text



## Решение типичных проблем

### Проблема 1: Не работает код

**Симптомы:**
- Пустая белая страница
- Ошибка 500

**Решение:**
```php
<?php
// Включите отображение ошибок для отладки
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Проверьте логи ошибок
// Linux: /var/log/apache2/error.log
// XAMPP: C:\xampp\apache\logs\error.log
?>
```text

### Проблема 2: Данные не сохраняются

**Симптомы:**
- Форма не работает
- Данные теряются

**Решение:**
```php
<?php
// Проверьте метод отправки
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Проверьте наличие данных
    var_dump($_POST);
    
    // Проверьте валидацию
    if (empty($_POST['name'])) {
        die("Name is required");
    }
}
?>
```text

### Проблема 3: Проблемы с кодировкой

**Симптомы:**
- Кракозябры вместо русских букв

**Решение:**
```php
<?php
// Установите кодировку
header('Content-Type: text/html; charset=utf-8');

// В БД используйте utf8mb4
$pdo = new PDO($dsn, $user, $pass, [
    PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8mb4"
]);
?>
```text



## Продвинутые темы

### Оптимизация производительности

```php
<?php
// Кеширование результатов
function get_expensive_data() {
    static $cache = null;
    
    if ($cache === null) {
        // Дорогая операция выполняется только раз
        $cache = heavy_computation();
    }
    
    return $cache;
}

// Использование опкода кеша (OPcache)
// Уже включено в современных версиях PHP
// Проверка: php -i | grep opcache
?>
```text

### Паттерны проектирования

```php
<?php
// Singleton pattern
class Database {
    private static $instance = null;
    private $connection;
    
    private function __construct() {
        $this->connection = new PDO($dsn, $user, $pass);
    }
    
    public static function getInstance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    public function getConnection() {
        return $this->connection;
    }
}

// Использование
$db = Database::getInstance()->getConnection();
?>
```text

### Тестирование

```php
<?php
// PHPUnit test example
use PHPUnit\Framework\TestCase;

class CalculatorTest extends TestCase {
    public function testAdd() {
        $calc = new Calculator();
        $result = $calc->add(2, 3);
        $this->assertEquals(5, $result);
    }
    
    public function testDivideByZero() {
        $this->expectException(DivisionByZeroError::class);
        $calc = new Calculator();
        $calc->divide(10, 0);
    }
}
?>
```text


## Практика


### Задание 1: Базовое

Создайте простой пример использования транзакции.

### Задание 2: Промежуточное

Реализуйте более сложную задачу с применением транзакции.

### Задание 3: Продвинутое

Создайте реальное приложение используя изученный материал.

### Задание 4: WordPress

Примените знания транзакции в контексте WordPress.

### Задание 5: Проект

Разработайте небольшой проект, демонстрирующий практическое применение темы.


## Онлайн-редакторы

Тестируйте примеры из этого урока:

- **PHPSandbox** (https://phpsandbox.io/) — полноценная PHP-среда в браузере
- **3v4l** (https://3v4l.org/) — тестирование кода на разных версиях PHP

## Итоги

В этом уроке вы изучили:


✅ Основные концепции  
✅ Практические примеры  
✅ Применение в WordPress  
✅ Best practices  
✅ Типичные ошибки и их решения  


### Следующий шаг

Переходите к следующему уроку для углубления знаний PHP.

### Ключевые моменты


1. Понимание основ — залог успеха
2. Практика важнее теории
3. Используйте примеры из реальной разработки
4. Изучайте код других разработчиков
5. Не бойтесь экспериментировать


**Совет:** Практикуйтесь с примерами из урока — это лучший способ запомнить материал!

---

**Готовы двигаться дальше?** Продолжайте изучение PHP!



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Транзакции в JavaScript</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <h1>Транзакции в JavaScript</h1>

    <div id="account-balance">Баланс: 100</div>

    <div class="transaction-form">
      <label for="amount">Сумма:</label>
      <input type="number" id="amount" placeholder="Введите сумму">
      <button id="deposit-button">Внести</button>
      <button id="withdraw-button">Снять</button>
    </div>

    <div id="transaction-history">
      <h2>История транзакций</h2>
      <ul id="history-list"></ul>
    </div>

    <div id="error-message" class="error"></div>
  </div>

  <script src="./index.js"></script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
}

h1, h2 {
  text-align: center;
  color: #ddd;
}

.transaction-form {
  display: flex;
  flex-direction: column;
  margin-bottom: 20px;
}

.transaction-form label {
  margin-bottom: 5px;
}

.transaction-form input {
  padding: 8px;
  margin-bottom: 10px;
  border: 1px solid #555;
  border-radius: 4px;
  background-color: #444;
  color: #eee;
}

.transaction-form button {
  padding: 10px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-bottom: 5px;
}

#deposit-button {
  background-color: #4CAF50;
  color: white;
}

#withdraw-button {
  background-color: #f44336;
  color: white;
}

#transaction-history ul {
  list-style: none;
  padding: 0;
}

#transaction-history li {
  padding: 8px;
  border-bottom: 1px solid #555;
}

.error {
  color: #f44336;
  text-align: center;
  margin-top: 10px;
}`,
    "/index.js": `// Имитация банковского счета с транзакциями
class BankAccount {
  constructor(initialBalance = 0) {
    this.balance = initialBalance;
    this.transactionHistory = [];
  }

  deposit(amount) {
    if (amount <= 0) {
      throw new Error("Сумма для внесения должна быть положительной.");
    }
    this.balance += amount;
    this.transactionHistory.push({ type: 'deposit', amount: amount });
  }

  withdraw(amount) {
    if (amount <= 0) {
      throw new Error("Сумма для снятия должна быть положительной.");
    }
    if (amount > this.balance) {
      throw new Error("Недостаточно средств на счете.");
    }
    this.balance -= amount;
    this.transactionHistory.push({ type: 'withdraw', amount: amount });
  }

  getBalance() {
    return this.balance;
  }

  getTransactionHistory() {
    return [...this.transactionHistory]; // Возвращаем копию, чтобы избежать изменений извне
  }
}

// Создаем экземпляр банковского счета
const account = new BankAccount(100);

// Получаем элементы DOM
const balanceElement = document.getElementById('account-balance');
const amountInput = document.getElementById('amount');
const depositButton = document.getElementById('deposit-button');
const withdrawButton = document.getElementById('withdraw-button');
const historyList = document.getElementById('history-list');
const errorMessage = document.getElementById('error-message');

// Функция обновления отображения баланса
function updateBalanceDisplay() {
  balanceElement.textContent = \`Баланс: \${account.getBalance()}\`;
}

// Функция обновления истории транзакций
function updateTransactionHistory() {
  historyList.innerHTML = ''; // Очищаем список

  const history = account.getTransactionHistory();
  history.forEach(transaction => {
    const listItem = document.createElement('li');
    listItem.textContent = \`\${transaction.type}: \${transaction.amount}\`;
    historyList.appendChild(listItem);
  });
}

// Обработчики событий для кнопок
depositButton.addEventListener('click', () => {
  try {
    const amount = parseFloat(amountInput.value);
    account.deposit(amount);
    updateBalanceDisplay();
    updateTransactionHistory();
    errorMessage.textContent = ''; // Очищаем сообщение об ошибке
  } catch (error) {
    errorMessage.textContent = error.message;
  }
});

withdrawButton.addEventListener('click', () => {
  try {
    const amount = parseFloat(amountInput.value);
    account.withdraw(amount);
    updateBalanceDisplay();
    updateTransactionHistory();
    errorMessage.textContent = ''; // Очищаем сообщение об ошибке
  } catch (error) {
    errorMessage.textContent = error.message;
  }
});

// Инициализация отображения
updateBalanceDisplay();
updateTransactionHistory();
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
