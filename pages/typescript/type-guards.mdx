## TypeScript: Броня - Type Guards


![Иллюстрация к уроку](/lessons/typescript-type-guards.png)
Type Guards (защитники типов) - это инструменты в TypeScript, позволяющие сузить тип переменной в определенной области кода. Они помогают компилятору понять, что переменная имеет более конкретный тип, чем было объявлено изначально. Это особенно полезно при работе с union types и `any`.

### Что такое Type Guards?

Представьте, что у вас есть переменная, которая может быть либо строкой, либо числом (union type). Как вы узнаете, выполнять ли операции, предназначенные только для строк, или только для чисел? Type Guards позволяют вам безопасно определить тип переменной и выполнить соответствующий код.

### Виды Type Guards

Существует несколько способов реализации Type Guards:

*   **`typeof`:**  Используется для примитивных типов (string, number, boolean, symbol, bigint, undefined, function).

    ```typescript
    function printValue(value: string | number) {
      if (typeof value === "string") {
        // Внутри этого блока value имеет тип string
        console.log(value.toUpperCase());
      } else {
        // Внутри этого блока value имеет тип number
        console.log(value * 2);
      }
    }

    printValue("hello"); // Выводит "HELLO"
    printValue(5);      // Выводит 10
    ```

*   **`instanceof`:** Используется для проверки, является ли объект экземпляром определенного класса.

    ```typescript
    class Animal {
      name: string;
      constructor(name: string) {
        this.name = name;
      }
    }

    class Dog extends Animal {
      bark() {
        console.log("Woof!");
      }
    }

    function makeSound(animal: Animal) {
      if (animal instanceof Dog) {
        // Внутри этого блока animal имеет тип Dog
        animal.bark();
      } else {
        console.log("Generic animal sound");
      }
    }

    const myDog = new Dog("Buddy");
    makeSound(myDog); // Выводит "Woof!"

    const myAnimal = new Animal("Generic");
    makeSound(myAnimal); // Выводит "Generic animal sound"
    ```

*   **`in`:**  Используется для проверки, существует ли определенное свойство в объекте.

    ```typescript
    interface Bird {
      fly(): void;
      layEggs(): void;
    }

    interface Fish {
      swim(): void;
      layEggs(): void;
    }

    function isBird(pet: Bird | Fish): pet is Bird {
      return "fly" in pet;
    }

    function petAction(pet: Bird | Fish) {
      if (isBird(pet)) {
        pet.fly();
      } else {
        pet.swim();
      }
    }
    ```

*   **User-Defined Type Guards:**  Функции, которые возвращают boolean и используют type predicate (`parameterName is Type`) в качестве типа возвращаемого значения.  Пример использования `in` выше является также и user-defined type guard.

### Жизненный пример

В React, например, часто используются Type Guards для работы с событиями.  Представьте себе компонент, который обрабатывает различные типы событий:

```typescript
interface KeyboardEvent {
  type: 'keyboard';
  key: string;
}

interface MouseEvent {
  type: 'mouse';
  x: number;
  y: number;
}

type Event = KeyboardEvent | MouseEvent;

function handleEvent(event: Event) {
  if (event.type === 'keyboard') {
    // Внутри этого блока event имеет тип KeyboardEvent
    console.log(`Key pressed: ${event.key}`);
  } else {
    // Внутри этого блока event имеет тип MouseEvent
    console.log(`Mouse clicked at: x=${event.x}, y=${event.y}`);
  }
}
```

Здесь мы используем проверку `event.type` для определения типа события и выполнения соответствующего кода.  Многие библиотеки и фреймворки используют подобные техники для обработки различных типов данных и событий.

### Ключевые моменты

*   Type Guards сужают тип переменной в определенной области кода.
*   `typeof`, `instanceof`, `in` - встроенные Type Guards.
*   User-Defined Type Guards позволяют создавать свои собственные проверки типов.
*   Type Guards улучшают безопасность и читаемость кода.
*   Они широко используются в библиотеках и фреймворках для обработки различных типов данных.



## Интерактивный пример

<Sandpack
  template="vanilla-ts"
  files={{
    "/index.ts": `
// Type Guards: Броня в TypeScript

// 1. Typeof Type Guard
function printValue(value: string | number) {
  const element = document.getElementById("typeof-output");
  if (typeof value === "string") {
    // Внутри этого блока value имеет тип string
    const result = value.toUpperCase();
    element.textContent = "Строка: " + result;
  } else {
    // Внутри этого блока value имеет тип number
    const result = value * 2;
    element.textContent = "Число: " + result;
  }
}

// 2. Instanceof Type Guard
class Animal {
  name: string;
  constructor(name: string) {
    this.name = name;
  }
  makeSound(): string {
    return "Generic animal sound";
  }
}

class Dog extends Animal {
  bark(): string {
    return "Woof!";
  }
  makeSound(): string {
    return this.bark();
  }
}

function animalSound(animal: Animal) {
  const element = document.getElementById("instanceof-output");
  if (animal instanceof Dog) {
    // Внутри этого блока animal имеет тип Dog
    element.textContent = animal.bark();
  } else {
    element.textContent = animal.makeSound();
  }
}

// 3. In Type Guard
interface Bird {
  fly(): void;
  layEggs(): void;
}

interface Fish {
  swim(): void;
  layEggs(): void;
}

function isBird(pet: Bird | Fish): pet is Bird {
  return "fly" in pet;
}

function petAction(pet: Bird | Fish) {
  const element = document.getElementById("in-output");
  if (isBird(pet)) {
    element.textContent = "Это птица, она летает!";
    pet.fly(); // Предполагаем, что у птицы есть метод fly
  } else {
    element.textContent = "Это рыба, она плавает!";
    pet.swim(); // Предполагаем, что у рыбы есть метод swim
  }
}

// 4. User-Defined Type Guard (пример с in) - уже показан выше

// Интерактивные элементы
document.addEventListener("DOMContentLoaded", () => {
  // Typeof
  const typeofInput = document.getElementById("typeof-input") as HTMLInputElement;
  const typeofButton = document.getElementById("typeof-button");

  typeofButton?.addEventListener("click", () => {
    const inputValue = typeofInput.value;
    if (!isNaN(Number(inputValue))) {
      printValue(Number(inputValue));
    } else {
      printValue(inputValue);
    }
  });

  // Instanceof
  const instanceofDogButton = document.getElementById("instanceof-dog-button");
  const instanceofAnimalButton = document.getElementById("instanceof-animal-button");

  instanceofDogButton?.addEventListener("click", () => {
    const myDog = new Dog("Buddy");
    animalSound(myDog);
  });

  instanceofAnimalButton?.addEventListener("click", () => {
    const myAnimal = new Animal("Generic");
    animalSound(myAnimal);
  });

  // In
  const inBirdButton = document.getElementById("in-bird-button");
  const inFishButton = document.getElementById("in-fish-button");

  inBirdButton?.addEventListener("click", () => {
    const bird: Bird = {
      fly: () => { console.log("Птица летит"); },
      layEggs: () => { console.log("Птица откладывает яйца"); }
    };
    petAction(bird);
  });

  inFishButton?.addEventListener("click", () => {
    const fish: Fish = {
      swim: () => { console.log("Рыба плывет"); },
      layEggs: () => { console.log("Рыба откладывает яйца"); }
    };
    petAction(fish);
  });
});
`
    ,
    "/index.html": `
<!DOCTYPE html>
<html>
<head>
  <title>TypeScript Type Guards</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #222;
      color: #eee;
    }
    button {
      background-color: #444;
      color: #eee;
      border: none;
      padding: 5px 10px;
      margin-right: 10px;
      cursor: pointer;
    }
    button:hover {
      background-color: #666;
    }
    input[type="text"] {
      background-color: #444;
      color: #eee;
      border: none;
      padding: 5px;
      margin-right: 10px;
    }
    div {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>TypeScript Type Guards</h1>

  <h2>Typeof</h2>
  <div>
    <input type="text" id="typeof-input" placeholder="Введите строку или число">
    <button id="typeof-button">Проверить typeof</button>
    <div id="typeof-output"></div>
  </div>

  <h2>Instanceof</h2>
  <div>
    <button id="instanceof-dog-button">Создать Dog</button>
    <button id="instanceof-animal-button">Создать Animal</button>
    <div id="instanceof-output"></div>
  </div>

  <h2>In</h2>
  <div>
    <button id="in-bird-button">Это Bird?</button>
    <button id="in-fish-button">Это Fish?</button>
    <div id="in-output"></div>
  </div>

  <script src="./index.ts"><\/script>
</body>
</html>
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400,
    theme: 'dark'
  }}
/>
