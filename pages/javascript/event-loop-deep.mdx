## JavaScript: Мозги. Event Loop глубже


![Иллюстрация к уроку](/lessons/javascript-event-loop-deep.png)
Event Loop – это сердце JavaScript, позволяющее ему быть неблокирующим, несмотря на однопоточную природу. В этом уроке мы копнем глубже и разберем, как он работает на самом деле.

### Что такое Event Loop и как он работает?

JavaScript работает в одном потоке, то есть выполняет код последовательно, строка за строкой. Но что происходит, когда нужно выполнить длительную операцию, например, запросить данные с сервера? Если бы JavaScript просто ждал завершения этой операции, интерфейс пользователя "завис" бы. Event Loop решает эту проблему.

Event Loop – это цикл, который постоянно проверяет, есть ли задачи в очереди задач (task queue). Если очередь не пуста, он берет первую задачу и помещает ее в стек вызовов (call stack) для выполнения.  Когда стек вызовов пуст, Event Loop снова проверяет очередь задач.

Ключевые компоненты:

*   **Call Stack (Стек вызовов):** Место, где выполняется JavaScript код.
*   **Task Queue (Очередь задач):** Место, где хранятся задачи, ожидающие выполнения. Задачи добавляются в очередь асинхронными операциями (например, `setTimeout`, `fetch`, обработчики событий).
*   **Event Loop:** Цикл, который следит за стеком вызовов и очередью задач.

Пример:

```javascript
console.log("Первый");

setTimeout(() => {
  console.log("Второй");
}, 0);

console.log("Третий");
```

Ожидаемый вывод:

```
Первый
Третий
Второй
```

Почему "Второй" выводится последним?

1.  `console.log("Первый")` помещается в стек вызовов, выполняется, и выводится "Первый".
2.  `setTimeout` помещается в стек вызовов, выполняется. Он добавляет функцию обратного вызова (callback) в очередь задач через 0 миллисекунд.
3.  `console.log("Третий")` помещается в стек вызовов, выполняется, и выводится "Третий".
4.  Стек вызовов пуст. Event Loop проверяет очередь задач. Там находится функция обратного вызова из `setTimeout`.
5.  Функция обратного вызова помещается в стек вызовов, выполняется, и выводится "Второй".

### Практические примеры

```javascript
// Пример с Promise
console.log("Начало");

const promise = new Promise((resolve) => {
  resolve("Promise выполнен");
});

promise.then((value) => {
  console.log(value);
});

console.log("Конец");

// Вывод:
// Начало
// Конец
// Promise выполнен
```

В этом примере `then` тоже добавляет задачу в очередь задач.

```javascript
// Пример с requestAnimationFrame
function animate() {
  console.log("Кадр анимации");
  requestAnimationFrame(animate);
}

requestAnimationFrame(animate);
```

`requestAnimationFrame` добавляет функцию обратного вызова в очередь задач для выполнения перед следующим перерисовыванием экрана.

### Жизненный пример

Event Loop лежит в основе любого современного JavaScript-приложения.

*   **Обработка пользовательского ввода:** Когда пользователь кликает по кнопке, браузер добавляет обработчик события клика в очередь задач. Event Loop обрабатывает этот обработчик, вызывая соответствующую функцию.
*   **Загрузка данных с сервера:** Когда вы делаете запрос к API, браузер добавляет функцию обратного вызова для обработки ответа в очередь задач. Event Loop обрабатывает эту функцию, когда данные загружены.
*   **Анимация:** `requestAnimationFrame` использует Event Loop для плавной анимации.

Фреймворки, такие как React, Angular и Vue.js, активно используют Event Loop для управления пользовательским интерфейсом и обработки асинхронных операций. Они полагаются на Event Loop, чтобы обновлять DOM, реагировать на действия пользователя и загружать данные без блокировки основного потока.

### Ключевые моменты

*   JavaScript – однопоточный язык, но Event Loop позволяет ему быть неблокирующим.
*   Event Loop постоянно проверяет стек вызовов и очередь задач.
*   Асинхронные операции добавляют задачи в очередь задач.
*   `setTimeout`, `Promises`, `fetch`, обработчики событий и `requestAnimationFrame` используют Event Loop.
*   Event Loop – основа для работы современных JavaScript-приложений и фреймворков.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Loop Demo</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Event Loop Demo</h1>
    <button id="myButton">Кликни меня!</button>
    <textarea id="myTextarea" placeholder="Введите текст"></textarea>
    <div id="output"></div>
  </div>
  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  text-align: center;
}

button {
  padding: 10px 20px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-bottom: 10px;
}

button:hover {
  background-color: #3e8e41;
}

textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid #555;
  border-radius: 4px;
  background-color: #444;
  color: #eee;
}

#output {
  margin-top: 10px;
  font-weight: bold;
}`,
    "/index.js": `// Получаем элементы DOM
const myButton = document.getElementById('myButton');
const myTextarea = document.getElementById('myTextarea');
const outputDiv = document.getElementById('output');

// Функция для демонстрации Event Loop
function demonstrateEventLoop() {
  console.log("Начало функции");
  outputDiv.textContent = "Начало функции";

  setTimeout(() => {
    console.log("setTimeout callback");
    outputDiv.textContent = "setTimeout callback";
  }, 0);

  Promise.resolve().then(() => {
    console.log("Promise then callback");
    outputDiv.textContent = "Promise then callback";
  });

  console.log("Конец функции");
  outputDiv.textContent = "Конец функции";
}

// Обработчик клика на кнопку
myButton.addEventListener('click', () => {
  console.log("Кнопка нажата");
  outputDiv.textContent = "Кнопка нажата";
  demonstrateEventLoop();
});

// Обработчик ввода в textarea
myTextarea.addEventListener('input', (event) => {
  const text = event.target.value;
  console.log(\`Текст в textarea: \${'text'}\`);
  // Добавляем небольшую задержку, чтобы показать неблокирующий характер
  setTimeout(() => {
    outputDiv.textContent = \`Вы ввели: \${'text'}\`;
  }, 50);
});

console.log("Скрипт загружен");
outputDiv.textContent = "Скрипт загружен. Нажмите кнопку или введите текст.";
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
