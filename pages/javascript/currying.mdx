import { Sandpack } from '@codesandbox/sandpack-react'

## JavaScript: Мозги. Урок: Каррирование и частичное применение

Каррирование и частичное применение – мощные техники функционального программирования, позволяющие создавать более гибкий и переиспользуемый код. Они позволяют "зафиксировать" часть аргументов функции, создавая новые функции с меньшей арностью (количеством ожидаемых аргументов).

### Что такое каррирование?

Каррирование – это преобразование функции, принимающей несколько аргументов, в последовательность функций, каждая из которых принимает только один аргумент.  Каждая функция возвращает другую функцию, ожидающую следующий аргумент, и так до тех пор, пока не будут переданы все аргументы, после чего возвращается результат.

```javascript
// Функция, принимающая два аргумента
function add(x, y) {
  return x + y;
}

// Каррированная версия функции add
function curriedAdd(x) {
  return function(y) {
    return x + y;
  };
}

// Использование
const add5 = curriedAdd(5); // add5 теперь функция, ожидающая один аргумент
console.log(add5(3)); // Выводит 8
console.log(curriedAdd(10)(2)); // Выводит 12
```

### Что такое частичное применение?

Частичное применение – это процесс, когда мы заранее предоставляем часть аргументов функции, создавая новую функцию с меньшим количеством необходимых аргументов.  В отличие от каррирования, частичное применение не обязательно преобразует функцию в последовательность функций, принимающих по одному аргументу.

```javascript
function greet(greeting, name) {
  return `${greeting}, ${name}!`;
}

// Частичное применение с использованием bind
const sayHello = greet.bind(null, "Hello"); // "Hello" зафиксирован как первый аргумент

console.log(sayHello("Alice")); // Выводит "Hello, Alice!"
console.log(sayHello("Bob"));   // Выводит "Hello, Bob!"

// Частичное применение без bind
function partialGreet(greeting) {
  return function(name) {
    return `${greeting}, ${name}!`;
  }
}

const sayGoodMorning = partialGreet("Good morning");
console.log(sayGoodMorning("Eve")); // Выводит "Good morning, Eve!"
```

### Практические примеры кода

```javascript
// Пример: функция для создания тегов HTML
function createTag(tag, attributes, content) {
  let attrString = "";
  for (const key in attributes) {
    attrString += ` ${key}="${attributes[key]}"`;
  }
  return `<${tag}${attrString}>${content}</${tag}>`;
}

// Каррированная версия
function curriedCreateTag(tag) {
  return function(attributes) {
    return function(content) {
      let attrString = "";
      for (const key in attributes) {
        attrString += ` ${key}="${attributes[key]}"`;
      }
      return `<${tag}${attrString}>${content}</${tag}>`;
    };
  };
}

const createDiv = curriedCreateTag("div");
const divWithClass = createDiv({ class: "container" });
console.log(divWithClass("Hello, world!")); // Выводит <div class="container">Hello, world!</div>

// Пример: частичное применение с bind для валидации
function validateInput(validator, input) {
  return validator(input);
}

function isEmailValid(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

const validateEmail = validateInput.bind(null, isEmailValid);

console.log(validateEmail("test@example.com")); // Выводит true
console.log(validateEmail("invalid-email"));    // Выводит false
```

### Жизненный пример

Во фреймворке React, каррирование и частичное применение часто используются при работе с компонентами высшего порядка (Higher-Order Components - HOC). HOC позволяют обернуть компонент для добавления дополнительной функциональности, например, авторизации или логирования.  Частичное применение позволяет передавать параметры в HOC, создавая кастомизированные обертки для компонентов.

В Redux, `connect` функция использует частичное применение для связывания состояния Redux с компонентами React.  `connect` принимает `mapStateToProps` и `mapDispatchToProps` как аргументы и возвращает новую функцию, которая, в свою очередь, принимает компонент React для обертывания.

### Ключевые моменты

*   Каррирование преобразует функцию с несколькими аргументами в последовательность функций с одним аргументом.
*   Частичное применение позволяет "зафиксировать" часть аргументов функции.
*   `bind` – удобный метод для частичного применения в JavaScript.
*   Эти техники повышают переиспользуемость и читаемость кода.
*   Часто используются во фреймворках React и Redux.

### Практика

Попробуйте примеры в интерактивном редакторе:

<Sandpack
  template="vanilla"
  files={{
    '/index.js': `// ============================
// Каррирование и частичное применение
// ============================

var app = document.getElementById('app');
var html = '';

// --- 1. Простое каррирование ---
function curriedAdd(x) {
  return function(y) {
    return x + y;
  };
}

var add5 = curriedAdd(5);
var add10 = curriedAdd(10);

var res1_a = add5(3);       // 8
var res1_b = add5(20);      // 25
var res1_c = add10(7);      // 17
var res1_d = add10(100);    // 110

console.log('add5(3) =', res1_a);
console.log('add5(20) =', res1_b);
console.log('add10(7) =', res1_c);
console.log('add10(100) =', res1_d);

html += '<div class="card">' +
  '<h3>1. Простое каррирование</h3>' +
  '<p class="desc">curriedAdd(x) возвращает функцию, ожидающую y</p>' +
  '<div class="code-block">' +
  '<code>var add5 = curriedAdd(5);</code><br>' +
  '<code>var add10 = curriedAdd(10);</code>' +
  '</div>' +
  '<div class="results">' +
  '<span class="tag">add5(3) = ' + res1_a + '</span>' +
  '<span class="tag">add5(20) = ' + res1_b + '</span>' +
  '<span class="tag">add10(7) = ' + res1_c + '</span>' +
  '<span class="tag">add10(100) = ' + res1_d + '</span>' +
  '</div>' +
  '</div>';

// --- 2. Универсальная функция curry ---
function curry(fn) {
  var arity = fn.length;
  return function curried() {
    var args = Array.prototype.slice.call(arguments);
    if (args.length >= arity) {
      return fn.apply(null, args);
    }
    return function() {
      var nextArgs = Array.prototype.slice.call(arguments);
      return curried.apply(null, args.concat(nextArgs));
    };
  };
}

function multiply(a, b, c) {
  return a * b * c;
}

var curriedMultiply = curry(multiply);
var res2_a = curriedMultiply(2)(3)(4);    // 24
var res2_b = curriedMultiply(2, 3)(4);    // 24
var res2_c = curriedMultiply(2)(3, 4);    // 24
var res2_d = curriedMultiply(2, 3, 4);    // 24

console.log('curriedMultiply(2)(3)(4) =', res2_a);
console.log('curriedMultiply(2, 3)(4) =', res2_b);
console.log('curriedMultiply(2)(3, 4) =', res2_c);
console.log('curriedMultiply(2, 3, 4) =', res2_d);

html += '<div class="card">' +
  '<h3>2. Универсальная функция curry()</h3>' +
  '<p class="desc">Автоматически каррирует любую функцию, поддерживая все варианты вызова</p>' +
  '<div class="code-block">' +
  '<code>var curriedMultiply = curry(multiply);</code>' +
  '</div>' +
  '<div class="results">' +
  '<span class="tag">curry(2)(3)(4) = ' + res2_a + '</span>' +
  '<span class="tag">curry(2, 3)(4) = ' + res2_b + '</span>' +
  '<span class="tag">curry(2)(3, 4) = ' + res2_c + '</span>' +
  '<span class="tag">curry(2, 3, 4) = ' + res2_d + '</span>' +
  '</div>' +
  '</div>';

// --- 3. Композиция функций ---
function compose() {
  var fns = Array.prototype.slice.call(arguments);
  return function(x) {
    var i = fns.length - 1;
    var result = x;
    while (i >= 0) {
      result = fns[i](result);
      i--;
    }
    return result;
  };
}

function double(n) { return n * 2; }
function increment(n) { return n + 1; }
function square(n) { return n * n; }

var transform = compose(square, increment, double);
// Порядок: double(3)=6 -> increment(6)=7 -> square(7)=49

var res3_a = transform(3);  // 49
var res3_b = transform(5);  // 121: double(5)=10, increment(10)=11, square(11)=121
var res3_c = transform(0);  // 1: double(0)=0, increment(0)=1, square(1)=1

console.log('compose(square, increment, double)(3) =', res3_a);
console.log('compose(square, increment, double)(5) =', res3_b);
console.log('compose(square, increment, double)(0) =', res3_c);

html += '<div class="card">' +
  '<h3>3. Композиция функций</h3>' +
  '<p class="desc">compose(f, g, h)(x) выполняет справа налево: f(g(h(x)))</p>' +
  '<div class="code-block">' +
  '<code>var transform = compose(square, increment, double);</code><br>' +
  '<code>// double(3)=6 -> increment(6)=7 -> square(7)=49</code>' +
  '</div>' +
  '<div class="results">' +
  '<span class="tag">transform(3) = ' + res3_a + '</span>' +
  '<span class="tag">transform(5) = ' + res3_b + '</span>' +
  '<span class="tag">transform(0) = ' + res3_c + '</span>' +
  '</div>' +
  '</div>';

// --- 4. Частичное применение с bind() ---
function greet(greeting, punctuation, name) {
  return greeting + ', ' + name + punctuation;
}

var sayHello = greet.bind(null, 'Hello', '!');
var sayGoodbye = greet.bind(null, 'Goodbye', '...');

var res4_a = sayHello('Alice');     // "Hello, Alice!"
var res4_b = sayHello('Bob');       // "Hello, Bob!"
var res4_c = sayGoodbye('Charlie'); // "Goodbye, Charlie..."
var res4_d = sayGoodbye('Diana');   // "Goodbye, Diana..."

console.log('sayHello("Alice") =', res4_a);
console.log('sayHello("Bob") =', res4_b);
console.log('sayGoodbye("Charlie") =', res4_c);
console.log('sayGoodbye("Diana") =', res4_d);

html += '<div class="card">' +
  '<h3>4. Частичное применение с bind()</h3>' +
  '<p class="desc">bind() фиксирует первые аргументы, создавая специализированные функции</p>' +
  '<div class="code-block">' +
  '<code>var sayHello = greet.bind(null, "Hello", "!");</code><br>' +
  '<code>var sayGoodbye = greet.bind(null, "Goodbye", "...");</code>' +
  '</div>' +
  '<div class="results">' +
  '<span class="tag">sayHello("Alice") = "' + res4_a + '"</span>' +
  '<span class="tag">sayHello("Bob") = "' + res4_b + '"</span>' +
  '<span class="tag">sayGoodbye("Charlie") = "' + res4_c + '"</span>' +
  '<span class="tag">sayGoodbye("Diana") = "' + res4_d + '"</span>' +
  '</div>' +
  '</div>';

// --- 5. Практический пример: конвейер обработки данных ---
var users = [
  { name: 'Alice', age: 25, score: 85 },
  { name: 'Bob', age: 30, score: 92 },
  { name: 'Charlie', age: 22, score: 78 },
  { name: 'Diana', age: 28, score: 95 }
];

function filterBy(prop, threshold) {
  return function(arr) {
    return arr.filter(function(item) {
      return item[prop] >= threshold;
    });
  };
}

function sortBy(prop) {
  return function(arr) {
    return arr.slice().sort(function(a, b) {
      return b[prop] - a[prop];
    });
  };
}

function formatNames(arr) {
  return arr.map(function(item) {
    return item.name + ' (score: ' + item.score + ')';
  });
}

var pipeline = compose(formatNames, sortBy('score'), filterBy('score', 80));
var topUsers = pipeline(users);

console.log('Top users:', topUsers);

html += '<div class="card">' +
  '<h3>5. Конвейер обработки данных</h3>' +
  '<p class="desc">Комбинация каррирования и композиции для обработки массивов</p>' +
  '<div class="code-block">' +
  '<code>var pipeline = compose(formatNames, sortBy("score"), filterBy("score", 80));</code>' +
  '</div>' +
  '<div class="results">' +
  '<span class="tag">' + topUsers.join('</span><span class="tag">') + '</span>' +
  '</div>' +
  '</div>';

app.innerHTML = '<h2>Каррирование и частичное применение</h2>' + html;

console.log('--- Все примеры выполнены! ---');
`,
    '/index.html': `<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="app"></div>
  <script src="index.js"></script>
</body>
</html>`,
    '/styles.css': `body {
  font-family: system-ui, -apple-system, sans-serif;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  margin: 0;
  min-height: 100vh;
}

h2 {
  color: white;
  text-align: center;
  margin: 0 0 20px 0;
  font-size: 1.4em;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

#app {
  max-width: 640px;
  margin: 0 auto;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.card h3 {
  margin: 0 0 8px 0;
  color: #667eea;
  font-size: 1.15em;
}

.card .desc {
  margin: 0 0 12px 0;
  color: #666;
  font-size: 0.9em;
  line-height: 1.4;
}

.code-block {
  background: #f4f4f8;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  overflow-x: auto;
}

.code-block code {
  font-family: 'Courier New', Courier, monospace;
  font-size: 0.85em;
  color: #333;
}

.results {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tag {
  display: inline-block;
  background: linear-gradient(135deg, #667eea22, #764ba222);
  border: 1px solid #667eea44;
  color: #444;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85em;
  font-family: 'Courier New', Courier, monospace;
}`
  }}
/>
