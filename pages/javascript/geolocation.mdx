## JavaScript: Мозги. Урок: Geolocation


![Иллюстрация к уроку](/lessons/javascript-geolocation.png)
Geolocation API позволяет веб-приложениям получать географическое местоположение пользователя. Это открывает двери для создания интерактивных карт, рекомендаций ближайших заведений и многого другого.

### Что такое Geolocation API?

Geolocation API – это интерфейс в JavaScript, предоставляющий доступ к местоположению пользователя. Он работает через объект `navigator.geolocation`. Важно помнить, что для получения местоположения требуется разрешение пользователя.

#### Как это работает?

Основной метод, который мы используем – это `getCurrentPosition()`. Он принимает три аргумента:

1.  **successCallback:** Функция, которая вызывается при успешном определении местоположения. Получает объект `GeolocationPosition`.
2.  **errorCallback (необязательный):** Функция, которая вызывается при ошибке определения местоположения. Получает объект `GeolocationPositionError`.
3.  **options (необязательный):** Объект с опциями для настройки запроса местоположения.

#### Пример кода: Получение координат

```javascript
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    function(position) {
      // Функция, вызываемая при успешном получении координат
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      console.log("Широта: " + latitude + ", Долгота: " + longitude);

      // Здесь можно обновить содержимое страницы, например, показать координаты
      document.getElementById("latitude").textContent = latitude;
      document.getElementById("longitude").textContent = longitude;
    },
    function(error) {
      // Функция, вызываемая при ошибке
      switch(error.code) {
        case error.PERMISSION_DENIED:
          console.error("Пользователь отклонил запрос на определение местоположения.");
          break;
        case error.POSITION_UNAVAILABLE:
          console.error("Информация о местоположении недоступна.");
          break;
        case error.TIMEOUT:
          console.error("Время ожидания запроса истекло.");
          break;
        case error.UNKNOWN_ERROR:
          console.error("Произошла неизвестная ошибка.");
          break;
      }
    }
  );
} else {
  console.error("Geolocation не поддерживается этим браузером.");
}
```

#### Пример HTML для отображения координат

```html
<!DOCTYPE html>
<html>
<head>
  <title>Geolocation Example</title>
</head>
<body>
  <h1>Ваши координаты:</h1>
  <p>Широта: <span id="latitude"></span></p>
  <p>Долгота: <span id="longitude"></span></p>

  <script src="script.js"></script> <!-- Подключите ваш JavaScript файл -->
</body>
</html>
```

### Жизненный пример

Geolocation API активно используется в различных веб-приложениях и сервисах:

*   **Карты и навигация:** Google Maps, Яндекс.Карты используют Geolocation для определения вашего местоположения и построения маршрутов.
*   **Локальные сервисы:** Приложения для заказа еды, такси, поиска ближайших ресторанов и магазинов.
*   **Социальные сети:** Отметка местоположения в постах и Stories.
*   **Реклама:** Таргетированная реклама, основанная на местоположении пользователя.
*   **Фреймворки:** Многие JavaScript фреймворки (React, Angular, Vue) предоставляют библиотеки или компоненты для упрощения работы с Geolocation API.

### Ключевые моменты

*   **Разрешение пользователя:** Обязательно запрашивайте разрешение пользователя перед получением его местоположения.
*   **Обработка ошибок:** Предусмотрите обработку возможных ошибок, таких как отказ в разрешении, недоступность информации о местоположении или истечение времени ожидания.
*   **Конфиденциальность:** Уважайте конфиденциальность пользователей и используйте данные о местоположении только в необходимых случаях.
*   **Точность:** Точность определения местоположения может варьироваться в зависимости от устройства и условий окружающей среды.
*   **Безопасность:** Используйте HTTPS для защиты данных о местоположении.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geolocation Demo</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Определение местоположения</h1>
    <p>Нажмите кнопку, чтобы узнать ваши координаты:</p>
    <button id="getLocationBtn">Получить местоположение</button>

    <div id="locationInfo" class="hidden">
      <p>Широта: <span id="latitude"></span></p>
      <p>Долгота: <span id="longitude"></span></p>
      <p>Точность: <span id="accuracy"></span> метров</p>
      <button id="showMapBtn">Показать на карте</button>
      <div id="mapLinkContainer" class="hidden">
        <a id="mapLink" href="" target="_blank">Открыть в Google Maps</a>
      </div>
    </div>

    <div id="errorMsg" class="hidden">
      <p id="errorMessage"></p>
    </div>
  </div>

  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  text-align: center;
}

button {
  background-color: #4CAF50;
  border: none;
  color: white;
  padding: 10px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 4px;
}

button:hover {
  background-color: #3e8e41;
}

.hidden {
  display: none;
}

#locationInfo {
  margin-top: 20px;
}

#errorMsg {
  color: #f44336;
  margin-top: 20px;
}

#mapLinkContainer {
  margin-top: 10px;
}
`,
    "/index.js": `// Получаем элементы DOM
const getLocationBtn = document.getElementById("getLocationBtn");
const locationInfo = document.getElementById("locationInfo");
const latitudeSpan = document.getElementById("latitude");
const longitudeSpan = document.getElementById("longitude");
const accuracySpan = document.getElementById("accuracy");
const errorMsg = document.getElementById("errorMsg");
const errorMessage = document.getElementById("errorMessage");
const showMapBtn = document.getElementById("showMapBtn");
const mapLink = document.getElementById("mapLink");
const mapLinkContainer = document.getElementById("mapLinkContainer");

// Функция для обработки успешного получения местоположения
function success(position) {
  const latitude = position.coords.latitude;
  const longitude = position.coords.longitude;
  const accuracy = position.coords.accuracy;

  latitudeSpan.textContent = latitude;
  longitudeSpan.textContent = longitude;
  accuracySpan.textContent = accuracy;

  locationInfo.classList.remove("hidden");
  errorMsg.classList.add("hidden");

  // Создаем ссылку на Google Maps
  const mapUrl = \`https://www.google.com/maps?q=\${latitude},\${longitude}\`;
  mapLink.href = mapUrl;
  mapLinkContainer.classList.remove("hidden");
}

// Функция для обработки ошибки получения местоположения
function error(err) {
  console.warn(\`ERROR(\${err.code}): \${err.message}\`);
  errorMessage.textContent = \`Ошибка: \${err.message}\`;
  errorMsg.classList.remove("hidden");
  locationInfo.classList.add("hidden");
  mapLinkContainer.classList.add("hidden");
}

// Опции для getCurrentPosition (необязательно)
const options = {
  enableHighAccuracy: true, // Попытаться получить наиболее точное местоположение
  timeout: 5000,            // Максимальное время ожидания (в миллисекундах)
  maximumAge: 0             // Не использовать кэшированное местоположение
};

// Обработчик клика на кнопку "Получить местоположение"
getLocationBtn.addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(success, error, options);
  } else {
    errorMessage.textContent = "Geolocation не поддерживается этим браузером.";
    errorMsg.classList.remove("hidden");
  }
});

showMapBtn.addEventListener("click", () => {
  // Ничего не делаем, ссылка уже создана в success()
});
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
