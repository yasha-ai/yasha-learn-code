import { Sandpack } from '@codesandbox/sandpack-react'

# Debounce –∏ Throttle

Debounce –∏ Throttle ‚Äî —Ç–µ—Ö–Ω–∏–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–π. –ù–µ–∑–∞–º–µ–Ω–∏–º—ã –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Å–æ–±—ã—Ç–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ—Ç–Ω–∏ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É: `scroll`, `resize`, `input`, `mousemove`.

## –ü—Ä–æ–±–ª–µ–º–∞: —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã

```javascript
// –ë–ï–ó –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ‚Äî –≤—ã–∑–æ–≤ API –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –∫–ª–∞–≤–∏—à–∏
input.addEventListener('input', (e) => {
  fetch(`/api/search?q=${e.target.value}`) // üí• –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª!
})

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–±–∏—Ä–∞–µ—Ç "JavaScript" (10 —Å–∏–º–≤–æ–ª–æ–≤) ‚Üí 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
// –ù—É–∂–Ω–æ: 1 –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –ø–∞—É–∑—ã –≤ –Ω–∞–±–æ—Ä–µ
```

## Debounce ‚Äî ¬´–æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç¬ª –≤—ã–∑–æ–≤

Debounce –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø—Ä–æ—à–ª–æ `delay` –º—Å **–±–µ–∑ –Ω–æ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤**. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.

```javascript
function debounce(fn, delay) {
  let timer

  return function(...args) {
    clearTimeout(timer) // –æ—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
    timer = setTimeout(() => {
      fn.apply(this, args)
    }, delay)
  }
}

// –ü–æ–∏—Å–∫ ‚Äî –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 300–º—Å –ø–æ—Å–ª–µ –ø–∞—É–∑—ã –≤ –Ω–∞–±–æ—Ä–µ
const search = debounce((query) => {
  console.log(`–ü–æ–∏—Å–∫: "${query}"`)
  // fetch(`/api/search?q=${query}`)
}, 300)

search('J')          // –æ—Ç–º–µ–Ω—ë–Ω
search('Ja')         // –æ—Ç–º–µ–Ω—ë–Ω
search('Jav')        // –æ—Ç–º–µ–Ω—ë–Ω
search('JavaScript') // –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ 300–º—Å
```

### Debounce —Å immediate (leading edge)

```javascript
function debounce(fn, delay, immediate = false) {
  let timer

  return function(...args) {
    const callNow = immediate && !timer

    clearTimeout(timer)
    timer = setTimeout(() => {
      timer = null
      if (!immediate) fn.apply(this, args)
    }, delay)

    if (callNow) fn.apply(this, args)
  }
}

// immediate=true: –≤—ã–∑–æ–≤ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –ø–æ—Ç–æ–º –ø–∞—É–∑–∞
const saveNow = debounce(save, 1000, true)
saveNow() // –≤—ã–∑–æ–≤ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ ‚úÖ
saveNow() // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–ø–∞—É–∑–∞)
saveNow() // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
// –ß–µ—Ä–µ–∑ 1000–º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ ‚Üí —Å–ª–µ–¥—É—é—â–∏–π saveNow() –≤—ã–∑–æ–≤–µ—Ç—Å—è —Å–Ω–æ–≤–∞
```

### Debounce —Å –æ—Ç–º–µ–Ω–æ–π

```javascript
function debounce(fn, delay) {
  let timer

  function debounced(...args) {
    clearTimeout(timer)
    return new Promise((resolve) => {
      timer = setTimeout(() => resolve(fn.apply(this, args)), delay)
    })
  }

  debounced.cancel = () => {
    clearTimeout(timer)
    timer = null
  }

  debounced.flush = function(...args) {
    clearTimeout(timer)
    return fn.apply(this, args)
  }

  return debounced
}

const debouncedSave = debounce(save, 500)

// –ü—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
window.addEventListener('beforeunload', () => {
  debouncedSave.flush() // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ!
})
```

## Throttle ‚Äî ¬´–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç¬ª —á–∞—Å—Ç–æ—Ç—É

Throttle –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–µ—Ç—Å—è **–Ω–µ —á–∞—â–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –≤ `delay` –º—Å**. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è scroll –∏ resize.

```javascript
function throttle(fn, delay) {
  let lastCall = 0

  return function(...args) {
    const now = Date.now()
    if (now - lastCall >= delay) {
      lastCall = now
      return fn.apply(this, args)
    }
  }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –º–∞–∫—Å–∏–º—É–º 10 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É (–∫–∞–∂–¥—ã–µ 100–º—Å)
const handleScroll = throttle(() => {
  console.log('–°–∫—Ä–æ–ª–ª:', window.scrollY)
}, 100)

window.addEventListener('scroll', handleScroll)
```

### Throttle —Å trailing call (–ø–æ —Ç–∞–π–º–µ—Ä—É)

```javascript
function throttle(fn, delay) {
  let lastCall = 0
  let timer = null

  return function(...args) {
    const now = Date.now()
    const remaining = delay - (now - lastCall)

    if (remaining <= 0) {
      if (timer) { clearTimeout(timer); timer = null }
      lastCall = now
      fn.apply(this, args)
    } else if (!timer) {
      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤
      timer = setTimeout(() => {
        lastCall = Date.now()
        timer = null
        fn.apply(this, args)
      }, remaining)
    }
  }
}
```

## Debounce vs Throttle: –∫–æ–≥–¥–∞ —á—Ç–æ

| | Debounce | Throttle |
|--|---------|---------|
| –ü–æ–∏—Å–∫/–∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ | ‚úÖ | ‚ùå |
| –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ | ‚úÖ | ‚ùå |
| Scroll/resize | ‚ùå | ‚úÖ |
| –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∑–∞–≥—Ä—É–∑–∫–∏ | ‚ùå | ‚úÖ |
| –ö–Ω–æ–ø–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª | ‚úÖ | ‚úÖ |
| Mousemove/–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã | ‚ùå | ‚úÖ |

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω: requestAnimationFrame throttle

```javascript
function rafThrottle(fn) {
  let scheduled = false

  return function(...args) {
    if (!scheduled) {
      scheduled = true
      requestAnimationFrame(() => {
        fn.apply(this, args)
        scheduled = false
      })
    }
  }
}

// –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
const updatePosition = rafThrottle((x, y) => {
  cursor.style.transform = `translate(${x}px, ${y}px)`
})

document.addEventListener('mousemove', (e) => {
  updatePosition(e.clientX, e.clientY)
})
```
