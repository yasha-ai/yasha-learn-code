# JavaScript: Мозги. Урок "CommonJS vs ESM"


![Иллюстрация к уроку](/lessons/javascript-commonjs-vs-esm.png)
Добро пожаловать на урок, посвященный модульным системам JavaScript! Сегодня мы разберемся с двумя основными подходами к организации кода: CommonJS и ESM (ECMAScript Modules). Понимание этих систем критически важно для работы с современным JavaScript.

## Что такое модульная система?

Представьте, что у вас есть огромная куча LEGO. Модульная система - это способ рассортировать эти LEGO по коробкам, чтобы потом легко найти нужные детали и собрать что-то сложное. В JavaScript модули позволяют разделять код на независимые части, которые можно переиспользовать и комбинировать.

## CommonJS

CommonJS - это старая модульная система, изначально разработанная для Node.js (серверный JavaScript). Она использует функции `require` для импорта модулей и `module.exports` для их экспорта.

```javascript
// moduleA.js (экспортирует модуль)
const greeting = "Привет!";

function sayHello(name) {
  return `${greeting} ${name}!`;
}

module.exports = {
  sayHello: sayHello
};

// moduleB.js (импортирует модуль)
const moduleA = require('./moduleA');

console.log(moduleA.sayHello("Мир")); // Выведет: Привет! Мир!
```

Здесь `moduleA.js` экспортирует функцию `sayHello`, а `moduleB.js` импортирует ее с помощью `require`.  Обратите внимание на `./moduleA` - это относительный путь к файлу.

## ESM (ECMAScript Modules)

ESM - это более современная модульная система, которая является частью стандарта JavaScript (ECMAScript). Она использует ключевые слова `import` и `export`.

```javascript
// moduleA.js (экспортирует модуль)
const greeting = "Привет!";

export function sayHello(name) {
  return `${greeting} ${name}!`;
}

// moduleB.js (импортирует модуль)
import { sayHello } from './moduleA.js';

console.log(sayHello("Мир")); // Выведет: Привет! Мир!
```

В этом примере `moduleA.js` экспортирует функцию `sayHello` с помощью `export`, а `moduleB.js` импортирует ее с помощью `import { sayHello } from './moduleA.js'`. Важно отметить, что расширение `.js` в пути к файлу теперь обязательно.

### Различия между CommonJS и ESM

*   **Синтаксис:** `require/module.exports` (CommonJS) vs `import/export` (ESM).
*   **Асинхронность:** ESM - асинхронный (динамический) импорт, CommonJS - синхронный. Это значит, что ESM может загружать модули по требованию, что может улучшить производительность.
*   **Поддержка:** CommonJS хорошо поддерживается в Node.js, но требует транспиляции (преобразования кода) для использования в браузерах. ESM нативно поддерживается современными браузерами, но требует настройки в Node.js.

## Жизненный пример

В реальных проектах вы часто увидите оба подхода.

*   **Node.js:** Многие старые проекты все еще используют CommonJS. Новые проекты, как правило, переходят на ESM.
*   **React/Vue/Angular:** Эти фреймворки активно используют ESM для организации кода.  Например, при создании компонентов в React вы почти всегда будете использовать `import` и `export`.
*   **Webpack/Parcel/Rollup:** Эти сборщики модулей (bundlers) позволяют использовать и CommonJS, и ESM, преобразуя их в код, понятный браузерам.

Например, в React:

```javascript
// MyComponent.jsx
import React from 'react';

function MyComponent() {
  return (
    <h1>Привет, мир!</h1>
  );
}

export default MyComponent;
```

## Ключевые моменты

*   CommonJS и ESM - это две основные системы модулей в JavaScript.
*   CommonJS использует `require` и `module.exports`.
*   ESM использует `import` и `export`.
*   ESM является более современным и поддерживается нативно в браузерах.
*   Сборщики модулей (Webpack, Parcel, Rollup) помогают использовать обе системы.
*   Понимание модульных систем критически важно для организации и переиспользования кода.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CommonJS vs ESM</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>CommonJS vs ESM</h1>
    <p>Выберите модульную систему:</p>
    <button id="commonjsBtn">CommonJS</button>
    <button id="esmBtn">ESM</button>
    <div id="output"></div>
    <input type="text" id="nameInput" placeholder="Введите имя">
  </div>
  <script src="/index.js" type="module"><\/script>
</body>
</html>
`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}

button {
  background-color: #4CAF50;
  border: none;
  color: white;
  padding: 10px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 4px;
}

button:hover {
  background-color: #3e8e41;
}

input[type="text"] {
  padding: 8px;
  margin: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

#output {
  margin-top: 20px;
  font-size: 18px;
}
`,
    "/index.js": `// index.js (ESM)

import { sayHello as sayHelloESM } from './moduleESM.js';

// Функция для демонстрации CommonJS (работает только в Node.js окружении)
function demoCommonJS(name) {
  try {
    // Создаем временный файл CommonJS
    const fs = await import('node:fs');
    fs.writeFileSync('temp_module.cjs', \`module.exports = { sayHello: function(name) { return "Привет, CommonJS " + name + "!"; } };\`);

    const moduleCJS = await import('./temp_module.cjs');
    const greeting = moduleCJS.sayHello(name);
    fs.unlinkSync('temp_module.cjs'); // Удаляем временный файл
    return greeting;
  } catch (error) {
    console.error("CommonJS недоступен в браузере:", error);
    return "CommonJS недоступен в браузере.  Попробуйте в Node.js окружении.";
  }
}

document.getElementById('commonjsBtn').addEventListener('click', async () => {
  const name = document.getElementById('nameInput').value || 'Мир';
  const output = document.getElementById('output');
  const greeting = await demoCommonJS(name);
  output.textContent = greeting;
});

document.getElementById('esmBtn').addEventListener('click', () => {
  const name = document.getElementById('nameInput').value || 'Мир';
  const output = document.getElementById('output');
  const greeting = sayHelloESM(name);
  output.textContent = greeting;
});
`,
    "/moduleESM.js": `// moduleESM.js (ESM)

export function sayHello(name) {
  return \`Привет, ESM \${name}!\`;
}
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
