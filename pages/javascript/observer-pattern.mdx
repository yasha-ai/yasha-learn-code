import { Sandpack } from '@codesandbox/sandpack-react'

# Observer (–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å)

Observer ‚Äî –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–±—ä–µ–∫—Ç (Subject) –≤–µ–¥—ë—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π (Observers) –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –∏—Ö –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ –¥–ª—è —Å–∏—Å—Ç–µ–º —Å–æ–±—ã—Ç–∏–π, —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ EventEmitter.

## –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```javascript
class EventEmitter {
  #events = new Map()

  on(event, listener) {
    if (!this.#events.has(event)) {
      this.#events.set(event, new Set())
    }
    this.#events.get(event).add(listener)
    return () => this.off(event, listener) // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏
  }

  off(event, listener) {
    this.#events.get(event)?.delete(listener)
    return this
  }

  emit(event, ...args) {
    this.#events.get(event)?.forEach(listener => listener(...args))
    return this
  }

  once(event, listener) {
    const wrapper = (...args) => {
      listener(...args)
      this.off(event, wrapper)
    }
    return this.on(event, wrapper)
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const emitter = new EventEmitter()

const unsubscribe = emitter.on('data', (value) => {
  console.log('–ü–æ–ª—É—á–µ–Ω–æ:', value)
})

emitter.emit('data', 42)     // '–ü–æ–ª—É—á–µ–Ω–æ: 42'
emitter.emit('data', 'hello') // '–ü–æ–ª—É—á–µ–Ω–æ: hello'

unsubscribe() // –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è

emitter.emit('data', '–µ—â—ë') // –Ω–∏—á–µ–≥–æ ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ —Å–Ω—è—Ç–∞
```

## Observer —Å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏

```javascript
class Store extends EventEmitter {
  #state

  constructor(initialState) {
    super()
    this.#state = initialState
  }

  get state() { return { ...this.#state } }

  setState(updates) {
    const prevState = this.#state
    this.#state = { ...this.#state, ...updates }

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–º –ø–æ–ª–µ
    for (const key in updates) {
      if (prevState[key] !== this.#state[key]) {
        this.emit(`change:${key}`, this.#state[key], prevState[key])
      }
    }
    this.emit('change', this.#state, prevState)
  }
}

const store = new Store({ count: 0, user: null, theme: 'dark' })

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–æ–ª–µ
store.on('change:count', (newVal, oldVal) => {
  console.log(`count: ${oldVal} ‚Üí ${newVal}`)
})

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ª—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
store.on('change', (state) => {
  document.title = `–°—á—ë—Ç: ${state.count}` // –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
})

store.setState({ count: 1 })  // count: 0 ‚Üí 1
store.setState({ count: 5 })  // count: 1 ‚Üí 5
store.setState({ user: { name: '–Ø—à–∞' } }) // —Ç–æ–ª—å–∫–æ 'change' —Å–æ–±—ã—Ç–∏–µ
```

## Subject + Observer: –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π GoF

```javascript
// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è
class Observer {
  update(data) { throw new Error('–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ') }
}

// –¢–µ–º–∞ (Subject)
class WeatherStation {
  #observers = new Set()
  #temperature = 0
  #humidity = 0

  subscribe(observer) { this.#observers.add(observer); return this }
  unsubscribe(observer) { this.#observers.delete(observer); return this }

  #notify() {
    const data = { temperature: this.#temperature, humidity: this.#humidity }
    this.#observers.forEach(obs => obs.update(data))
  }

  setWeather(temp, humidity) {
    this.#temperature = temp
    this.#humidity = humidity
    this.#notify()
  }
}

// –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏
class TemperatureDisplay extends Observer {
  update({ temperature }) {
    console.log(`üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${temperature}¬∞C`)
  }
}

class HumidityDisplay extends Observer {
  update({ humidity }) {
    console.log(`üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${humidity}%`)
  }
}

class AlertSystem extends Observer {
  update({ temperature, humidity }) {
    if (temperature > 35) console.log('üî• ALERT: –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞!')
    if (humidity > 80) console.log('üí¶ ALERT: –í—ã—Å–æ–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å!')
  }
}

const station = new WeatherStation()
const tempDisplay = new TemperatureDisplay()
const humidDisplay = new HumidityDisplay()
const alerts = new AlertSystem()

station
  .subscribe(tempDisplay)
  .subscribe(humidDisplay)
  .subscribe(alerts)

station.setWeather(25, 60) // –û–±—ã—á–Ω–∞—è –ø–æ–≥–æ–¥–∞
station.setWeather(37, 85) // ALERT!

station.unsubscribe(humidDisplay)
station.setWeather(20, 50) // humidDisplay –±–æ–ª—å—à–µ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```

## –†–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å Proxy

```javascript
function createReactive(target, onChange) {
  return new Proxy(target, {
    set(obj, key, value) {
      const old = obj[key]
      obj[key] = value
      if (old !== value) onChange(key, value, old)
      return true
    }
  })
}

const state = createReactive({ name: '–Ø—à–∞', age: 1 }, (key, val, old) => {
  console.log(`${key}: ${old} ‚Üí ${val}`)
  // –æ–±–Ω–æ–≤–ª—è–µ–º DOM –∏–ª–∏ —á—Ç–æ-—Ç–æ –µ—â—ë
})

state.name = '–ê–ª–µ–∫—Å–µ–π' // name: –Ø—à–∞ ‚Üí –ê–ª–µ–∫—Å–µ–π
state.age = 2          // age: 1 ‚Üí 2
```

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

**‚úÖ Observer –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- –°–∏—Å—Ç–µ–º—ã —Å–æ–±—ã—Ç–∏–π / EventBus
- –†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ UI —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ (React state, Vue reactive)
- WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ñ–∏–≤—ã–µ –¥–∞—à–±–æ—Ä–¥—ã –∏ real-time –¥–∞–Ω–Ω—ã–µ
- MVC: Model —É–≤–µ–¥–æ–º–ª—è–µ—Ç View
