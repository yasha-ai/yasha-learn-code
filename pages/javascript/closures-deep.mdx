## JavaScript: Мозги. Урок: Замыкания (closures) детально


![Иллюстрация к уроку](/lessons/javascript-closures-deep.png)
Замыкания – это мощный инструмент JavaScript, позволяющий функциям "запоминать" и получать доступ к переменным из лексического окружения, в котором они были созданы, даже после того, как это окружение перестало существовать. Понимание замыканий – ключ к написанию более эффективного и поддерживаемого кода.

### Что такое замыкание?

Простыми словами, замыкание – это функция, которая "помнит" переменные, объявленные вне ее тела.  Представьте, что функция забирает с собой маленький "рюкзак" с переменными из того места, где она была создана.

Рассмотрим пример:

```javascript
function outerFunction(outerVar) {
  function innerFunction(innerVar) {
    console.log("outerVar:", outerVar);
    console.log("innerVar:", innerVar);
  }
  return innerFunction;
}

const myInnerFunction = outerFunction("Привет из outer!");
myInnerFunction("Привет из inner!"); // Вывод: outerVar: Привет из outer! , innerVar: Привет из inner!
```

В этом примере `innerFunction` формирует замыкание вокруг `outerVar`. Даже после того, как `outerFunction` завершила свое выполнение, `innerFunction` все еще имеет доступ к `outerVar`.

### Практические примеры

**1. Счетчик:**

```javascript
function createCounter() {
  let count = 0;

  return {
    increment: function() {
      count++;
      console.log(count);
    },
    decrement: function() {
      count--;
      console.log(count);
    }
  };
}

const counter = createCounter();
counter.increment(); // Вывод: 1
counter.increment(); // Вывод: 2
counter.decrement(); // Вывод: 1
```

Здесь `count` является приватной переменной, доступной только через методы `increment` и `decrement`, возвращаемые функцией `createCounter`. Это достигается благодаря замыканию.

**2. Функция с задержкой:**

```javascript
function delayedLog(value, delay) {
  return function() {
    setTimeout(() => console.log(value), delay);
  };
}

const logHello = delayedLog("Привет!", 2000);
logHello(); // Вывод "Привет!" через 2 секунды
```

Функция, возвращаемая `delayedLog`, "помнит" `value` благодаря замыканию и использует его при вызове `console.log` внутри `setTimeout`.

### Жизненный пример

Замыкания активно используются в JavaScript-библиотеках и фреймворках для создания модулей, инкапсуляции данных и реализации паттернов проектирования.

*   **React Hooks:**  Хуки, такие как `useState` и `useEffect`, используют замыкания для сохранения состояния компонентов между рендерами.  Состояние, которое нужно сохранить, находится в замыкании, доступном только для хука.

*   **Event Listeners:** Когда мы добавляем обработчик события, функция-обработчик часто нуждается в доступе к данным, которые были доступны в момент добавления обработчика. Замыкания позволяют сохранить эти данные.

*   **Module Pattern:** Замыкания часто используются для создания приватных переменных и методов в модулях. Это позволяет скрывать внутреннюю реализацию модуля и предоставлять только необходимый интерфейс.

### Ключевые моменты

*   Замыкание – это функция вместе с лексическим окружением, в котором она была создана.
*   Замыкания позволяют функциям "запоминать" переменные из внешних областей видимости.
*   Замыкания обеспечивают инкапсуляцию данных и помогают создавать приватные переменные.
*   Замыкания широко используются в JavaScript-библиотеках и фреймворках для реализации различных паттернов проектирования.
*   Неправильное использование замыканий может привести к утечкам памяти, поэтому важно понимать, как они работают.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Замыкания в JavaScript</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Замыкания в JavaScript</h1>
    <p>Пример счетчика с использованием замыканий.</p>

    <div id="counter-container">
      <button id="increment-btn">Увеличить</button>
      <button id="decrement-btn">Уменьшить</button>
      <p>Счетчик: <span id="counter-value">0</span></p>
    </div>

    <p>Пример функции с задержкой.</p>
    <button id="delayed-log-btn">Вывести сообщение через 2 секунды</button>
    <p id="delayed-message"></p>

    <p>Пример с вводом пользователя и замыканием</p>
    <input type="text" id="name-input" placeholder="Введите ваше имя">
    <button id="greet-btn">Приветствовать</button>
    <p id="greeting-message"></p>
  </div>

  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  width: 80%;
  max-width: 600px;
}

button {
  background-color: #4CAF50;
  border: none;
  color: white;
  padding: 10px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 4px;
}

button:hover {
  background-color: #3e8e41;
}

input[type="text"] {
  padding: 8px;
  margin: 5px 0;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
  width: 100%;
  background-color: #444;
  color: #eee;
}
`,
    "/index.js": `// Пример счетчика с использованием замыканий
function createCounter() {
  let count = 0;

  return {
    increment: function() {
      count++;
      document.getElementById("counter-value").textContent = count;
    },
    decrement: function() {
      count--;
      document.getElementById("counter-value").textContent = count;
    }
  };
}

const counter = createCounter();
document.getElementById("increment-btn").addEventListener("click", counter.increment);
document.getElementById("decrement-btn").addEventListener("click", counter.decrement);

// Пример функции с задержкой
function delayedLog(message, delay) {
  return function() {
    setTimeout(() => {
      document.getElementById("delayed-message").textContent = message;
    }, delay);
  };
}

const logHello = delayedLog("Привет! Это сообщение с задержкой.", 2000);
document.getElementById("delayed-log-btn").addEventListener("click", logHello);

// Пример с вводом пользователя и замыканием
function createGreeter(name) {
  return function() {
    document.getElementById("greeting-message").textContent = "Привет, " + name + "!";
  };
}

document.getElementById("greet-btn").addEventListener("click", function() {
  const name = document.getElementById("name-input").value;
  const greet = createGreeter(name);
  greet();
});
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
