## JavaScript: Мозги. Урок: WebSocket


![Иллюстрация к уроку](/lessons/javascript-websocket.png)
WebSocket - это протокол, позволяющий установить постоянное двустороннее соединение между клиентом (например, браузером) и сервером. Это значит, что данные могут передаваться в обе стороны практически мгновенно, без необходимости постоянных запросов со стороны клиента.

### Что такое WebSocket?

WebSocket работает поверх TCP и предоставляет полнодуплексный канал связи.  В отличие от HTTP, где клиент делает запрос, а сервер отвечает, WebSocket позволяет серверу отправлять данные клиенту в любой момент, даже если клиент не отправлял запрос. Это особенно полезно для приложений, требующих мгновенного обновления данных, таких как чаты, онлайн-игры и мониторинг в реальном времени.

### Пример кода на стороне клиента (JavaScript)

```javascript
// Создаем новое WebSocket соединение
const socket = new WebSocket('ws://localhost:8080');

// Обработчик события открытия соединения
socket.addEventListener('open', (event) => {
  console.log('Соединение установлено!');
  // Отправляем сообщение на сервер после установки соединения
  socket.send('Привет, сервер!');
});

// Обработчик события получения сообщения от сервера
socket.addEventListener('message', (event) => {
  console.log('Сообщение от сервера: ', event.data);
});

// Обработчик события закрытия соединения
socket.addEventListener('close', (event) => {
  console.log('Соединение закрыто.');
});

// Обработчик события ошибки
socket.addEventListener('error', (event) => {
  console.error('Ошибка WebSocket: ', event);
});
```

### Пример кода на стороне сервера (Node.js с ws)

```javascript
const WebSocket = require('ws');

const wss = new WebSocket.Server({ port: 8080 });

wss.on('connection', ws => {
  console.log('Клиент подключился');

  ws.on('message', message => {
    console.log(`Получено сообщение: ${message}`);
    // Отправляем ответ клиенту
    ws.send(`Эхо: ${message}`);
  });

  ws.on('close', () => {
    console.log('Клиент отключился');
  });

  ws.onerror = function () {
    console.log('Произошла ошибка');
  }
});

console.log('WebSocket сервер запущен на порту 8080');
```

### Жизненный пример

*   **Чат-приложения:** WebSocket используется для передачи сообщений в реальном времени. Когда пользователь отправляет сообщение, оно немедленно отправляется всем участникам чата.
*   **Онлайн-игры:**  WebSocket обеспечивает мгновенную синхронизацию состояния игры между игроками, что необходимо для плавного и отзывчивого игрового процесса.
*   **Финансовые приложения:**  WebSocket используется для отображения котировок акций и других финансовых данных в режиме реального времени.
*   **Фреймворки:** Многие современные фреймворки, такие как Socket.IO (надстройка над WebSocket), упрощают работу с WebSocket и предоставляют дополнительные функции, такие как автоматическое переподключение и fallback на другие протоколы, если WebSocket недоступен.

### Ключевые моменты

*   WebSocket обеспечивает двустороннюю связь в реальном времени.
*   В отличие от HTTP, WebSocket поддерживает постоянное соединение.
*   WebSocket идеально подходит для приложений, требующих мгновенного обновления данных.
*   Для работы с WebSocket требуется реализация как на стороне клиента, так и на стороне сервера.
*   Socket.IO упрощает работу с WebSocket и предоставляет дополнительные возможности.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Пример</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>WebSocket Пример</h1>
    <div id="status">Соединение не установлено</div>
    <input type="text" id="messageInput" placeholder="Введите сообщение">
    <button id="sendButton">Отправить</button>
    <div id="messages">
      <h2>Сообщения:</h2>
      <ul id="messageList"></ul>
    </div>
  </div>
  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  width: 500px;
  text-align: center;
}

input[type="text"] {
  padding: 10px;
  margin: 10px 0;
  width: 80%;
  border: none;
  border-radius: 4px;
  background-color: #444;
  color: #eee;
}

button {
  padding: 10px 20px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background-color: #367c39;
}

#messages {
  margin-top: 20px;
  text-align: left;
}

#messageList {
  list-style-type: none;
  padding: 0;
}

#messageList li {
  padding: 8px;
  border-bottom: 1px solid #444;
}

#status {
  margin-bottom: 10px;
  font-weight: bold;
}
`,
    "/index.js": `// Создаем WebSocket соединение (замените на свой сервер, если необходимо)
const socket = new WebSocket('wss://echo.websocket.events'); // Используем echo-сервер для примера

// Получаем элементы DOM
const statusElement = document.getElementById('status');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const messageList = document.getElementById('messageList');

// Обработчик события открытия соединения
socket.addEventListener('open', (event) => {
  console.log('Соединение установлено!');
  statusElement.textContent = 'Соединение установлено';
});

// Обработчик события получения сообщения от сервера
socket.addEventListener('message', (event) => {
  console.log('Сообщение от сервера: ', event.data);
  const newMessage = document.createElement('li');
  newMessage.textContent = 'Сервер: ' + event.data;
  messageList.appendChild(newMessage);
});

// Обработчик события закрытия соединения
socket.addEventListener('close', (event) => {
  console.log('Соединение закрыто.');
  statusElement.textContent = 'Соединение закрыто';
});

// Обработчик события ошибки
socket.addEventListener('error', (event) => {
  console.error('Ошибка WebSocket: ', event);
  statusElement.textContent = 'Ошибка WebSocket';
});

// Обработчик нажатия на кнопку "Отправить"
sendButton.addEventListener('click', () => {
  const message = messageInput.value;
  if (message) {
    socket.send(message);
    const newMessage = document.createElement('li');
    newMessage.textContent = 'Вы: ' + message;
    messageList.appendChild(newMessage);
    messageInput.value = ''; // Очищаем поле ввода
  }
});
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
