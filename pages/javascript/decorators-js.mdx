import { Sandpack } from '@codesandbox/sandpack-react'

# –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –≤ JavaScript

–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å `@decorator` –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–æ–≤, –º–µ—Ç–æ–¥–æ–≤, —Å–≤–æ–π—Å—Ç–≤ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤. –í 2024 –≥–æ–¥—É –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–æ—Å—Ç–∏–≥–ª–∏ **Stage 3** –≤ TC39 –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Babel/TypeScript. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤ –≤–∞–∂–Ω–æ –¥–ª—è Angular, NestJS –∏ MobX.

> ‚ÑπÔ∏è **–°—Ç–∞—Ç—É—Å:** Stage 3 (–ø–æ—á—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç). –¢—Ä–µ–±—É–µ—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ (Babel/TypeScript) –∏–ª–∏ Node.js —Å —Ñ–ª–∞–≥–æ–º.

## –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã—Å—à–µ–≥–æ –ø–æ—Ä—è–¥–∫–∞

–î–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ ‚Äî –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```javascript
// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –º–µ—Ç–æ–¥–∞ ‚Äî –æ–±—ë—Ä—Ç–∫–∞
function readonly(target, key, descriptor) {
  descriptor.writable = false
  return descriptor
}

function log(target, key, descriptor) {
  const original = descriptor.value
  descriptor.value = function(...args) {
    console.log(`–í—ã–∑–æ–≤ ${key}(${args.join(', ')})`)
    const result = original.apply(this, args)
    console.log(`${key} ‚Üí ${result}`)
    return result
  }
  return descriptor
}

// –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä—É—á–Ω—É—é (–±–µ–∑ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ @)
class Calculator {
  add(a, b) { return a + b }
  multiply(a, b) { return a * b }
}

const desc = Object.getOwnPropertyDescriptor(Calculator.prototype, 'add')
Object.defineProperty(Calculator.prototype, 'add', log(Calculator.prototype, 'add', desc))

const calc = new Calculator()
calc.add(3, 4) // –í—ã–∑–æ–≤ add(3, 4) ‚Üí 7
```

## –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (Stage 3, 2024)

```javascript
// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –∫–ª–∞—Å—Å–∞
@sealed
class BankAccount { ... }

// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –º–µ—Ç–æ–¥–∞
class API {
  @log
  @retry(3)
  async fetchUser(id) { ... }
}

// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –ø–æ–ª—è
class User {
  @required
  @minLength(2)
  name = ''
}
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤

### @log ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤

```javascript
// –§—É–Ω–∫—Ü–∏—è-–¥–µ–∫–æ—Ä–∞—Ç–æ—Ä (Stage 3 API)
function log(originalMethod, context) {
  const methodName = context.name

  return function(...args) {
    console.log(`‚Üí ${methodName}(${args.map(a => JSON.stringify(a)).join(', ')})`)
    const result = originalMethod.apply(this, args)
    console.log(`‚Üê ${methodName} = ${JSON.stringify(result)}`)
    return result
  }
}

class MathService {
  add(a, b) { return a + b }
  multiply(a, b) { return a * b }
}

// –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä—É—á–Ω—É—é (–ø–æ–∫–∞ Stage 3 –Ω–µ –≤–µ–∑–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
const proto = MathService.prototype
for (const method of ['add', 'multiply']) {
  const desc = Object.getOwnPropertyDescriptor(proto, method)
  desc.value = log(desc.value, { name: method })
  Object.defineProperty(proto, method, desc)
}

const math = new MathService()
math.add(2, 3)       // ‚Üí add(2, 3) ‚Üê add = 5
math.multiply(4, 5)  // ‚Üí multiply(4, 5) ‚Üê multiply = 20
```

### @memoize ‚Äî –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```javascript
function memoize(fn) {
  const cache = new Map()
  return function(...args) {
    const key = JSON.stringify(args)
    if (cache.has(key)) {
      console.log(`[cache hit] ${fn.name}(${key})`)
      return cache.get(key)
    }
    const result = fn.apply(this, args)
    cache.set(key, result)
    return result
  }
}

function fibonacci(n) {
  if (n <= 1) return n
  return fibonacci(n - 1) + fibonacci(n - 2)
}

// –ë–µ–∑ –º–µ–º–æ–∏–∑–∞—Ü–∏–∏: 2^n –≤—ã–∑–æ–≤–æ–≤
// –° –º–µ–º–æ–∏–∑–∞—Ü–∏–µ–π:
const fastFib = memoize(function fib(n) {
  if (n <= 1) return n
  return fastFib(n - 1) + fastFib(n - 2)
})

console.time('fib')
console.log(fastFib(40)) // 102334155
console.timeEnd('fib')  // < 1–º—Å (–±–µ–∑ –∫—ç—à–∞ ‚Äî —Å–µ–∫—É–Ω–¥—ã)
```

### @debounce ‚Äî –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –º–µ—Ç–æ–¥–æ–≤

```javascript
function debounce(delay) {
  return function(originalMethod, context) {
    let timer

    return function(...args) {
      clearTimeout(timer)
      timer = setTimeout(() => originalMethod.apply(this, args), delay)
    }
  }
}

class SearchComponent {
  constructor() {
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –≤—Ä—É—á–Ω—É—é
    this.search = debounce(300)(this.search.bind(this), { name: 'search' })
  }

  search(query) {
    console.log(`–ü–æ–∏—Å–∫: "${query}"`)
    // fetch(`/api/search?q=${query}`)
  }
}

const search = new SearchComponent()
search.search('J')          // –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
search.search('JS')         // –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
search.search('JavaScript') // –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ 300–º—Å
```

### @validate ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

```javascript
function validate(rules) {
  return function(originalMethod) {
    return function(...args) {
      rules.forEach(({ index, check, message }) => {
        if (!check(args[index])) {
          throw new TypeError(`–ê—Ä–≥—É–º–µ–Ω—Ç ${index}: ${message}`)
        }
      })
      return originalMethod.apply(this, args)
    }
  }
}

class UserService {
  createUser(name, age, email) {
    return { name, age, email }
  }
}

// –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é
const service = new UserService()
const originalCreate = service.createUser.bind(service)
service.createUser = validate([
  { index: 0, check: (n) => typeof n === 'string' && n.length >= 2, message: '–∏–º—è –º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞' },
  { index: 1, check: (a) => typeof a === 'number' && a >= 0 && a <= 150, message: '–≤–æ–∑—Ä–∞—Å—Ç 0-150' },
  { index: 2, check: (e) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e), message: '–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email' },
])(originalCreate)

service.createUser('–ê–ª–µ–∫—Å–µ–π', 37, 'alex@example.com') // ‚úÖ
// service.createUser('A', -1, 'not-email') // ‚ùå TypeError
```

## TypeScript –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞—Ö

```typescript
// NestJS ‚Äî —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
@Controller('/users')
@UseGuards(AuthGuard)
class UsersController {
  @Get(':id')
  @UseInterceptors(LogInterceptor)
  async getUser(@Param('id') id: string) {
    return this.usersService.findOne(id)
  }
}

// MobX ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
class AppStore {
  @observable count = 0
  @observable user = null

  @action
  increment() { this.count++ }

  @computed
  get doubleCount() { return this.count * 2 }
}
```

## –ó–∞–¥–∞–Ω–∏—è –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏

1. –†–µ–∞–ª–∏–∑—É–π—Ç–µ `@once` ‚Äî –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –≤—ã–∑–≤–∞—Ç—å –º–µ—Ç–æ–¥ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
2. –°–æ–∑–¥–∞–π—Ç–µ `@retry(n)` ‚Äî –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä, –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ `n` —Ä–∞–∑ –ø—Ä–∏ –æ—à–∏–±–∫–µ.
3. –ù–∞–ø–∏—à–∏—Ç–µ `@time` ‚Äî –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–µ—Ç–æ–¥–∞.
4. –†–µ–∞–ª–∏–∑—É–π—Ç–µ `@deprecated(message)` ‚Äî –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –º–µ—Ç–æ–¥–∞.

## –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–∏–º–µ—Ä

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <h2>–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã ‚Äî –§—É–Ω–∫—Ü–∏—è –≤—ã—Å—à–µ–≥–æ –ø–æ—Ä—è–¥–∫–∞</h2>
  <div class="section">
    <h3>üóùÔ∏è –ú–µ–º–æ–∏–∑–∞—Ü–∏—è (memoize)</h3>
    <input id="fibN" type="number" value="10" min="0" max="45">
    <button id="calcFib">–í—ã—á–∏—Å–ª–∏—Ç—å –§–∏–±–æ–Ω–∞—á—á–∏</button>
    <div id="fibResult" class="result"></div>
  </div>
  <div class="section">
    <h3>üìù –õ–æ–≥ –≤—ã–∑–æ–≤–æ–≤ (log)</h3>
    <input id="a" type="number" value="5" placeholder="a">
    <input id="b" type="number" value="3" placeholder="b">
    <button id="calcAdd">–°–ª–æ–∂–∏—Ç—å</button>
    <div id="logOutput" class="log"></div>
  </div>
  <script src="/index.js"></script>
</body>
</html>`,
    "/styles.css": `body { font-family: sans-serif; background: #1e1e2e; color: #cdd6f4; padding: 20px; }
h2,h3 { color: #89b4fa; }
.section { background: #313244; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
input[type=number] { background: #1e1e2e; border: 1px solid #45475a; color: #cdd6f4; padding: 6px 10px; border-radius: 6px; width: 80px; }
button { background: #89b4fa; color: #1e1e2e; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 8px; }
.result { background: #1e1e2e; border-radius: 4px; padding: 10px; margin-top: 10px; font-family: monospace; }
.log { margin-top: 10px; }
.log-line { font-family: monospace; font-size: 13px; padding: 3px 0; border-bottom: 1px solid #45475a; }
.call { color: #89b4fa; }
.ret { color: #a6e3a1; }
.cached { color: #f9e2af; }`,
    "/index.js": `// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä memoize
function memoize(fn) {
  const cache = new Map()
  return function(...args) {
    const key = JSON.stringify(args)
    if (cache.has(key)) return { value: cache.get(key), cached: true }
    const result = fn.apply(this, args)
    cache.set(key, result)
    return { value: result, cached: false }
  }
}

// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä log
function log(fn, logEl) {
  return function(...args) {
    const line1 = document.createElement('div')
    line1.className = 'log-line call'
    line1.textContent = \`‚Üí \${fn.name}(\${args.join(', ')})\`
    logEl.prepend(line1)
    
    const result = fn.apply(this, args)
    
    const line2 = document.createElement('div')
    line2.className = 'log-line ret'
    line2.textContent = \`‚Üê = \${result}\`
    logEl.prepend(line2)
    return result
  }
}

// –ú–µ–º–æ–∏–∑–æ–≤–∞–Ω–Ω—ã–π –§–∏–±–æ–Ω–∞—á—á–∏
const fibCache = new Map()
const memoFib = memoize(function fib(n) {
  if (n <= 1) return n
  return (fibCache.get(n-1) ?? memoFib(n-1).value) +
         (fibCache.get(n-2) ?? memoFib(n-2).value)
})

// –õ–æ–≥–∏—Ä—É–µ–º—ã–π add
function add(a, b) { return a + b }
const logEl = document.getElementById('logOutput')
const loggedAdd = log(add, logEl)

document.getElementById('calcFib').addEventListener('click', () => {
  const n = parseInt(document.getElementById('fibN').value)
  const start = performance.now()
  const r = memoFib(n)
  const time = (performance.now() - start).toFixed(3)
  document.getElementById('fibResult').innerHTML =
    \`fib(\${n}) = <strong>\${r.value}</strong> \${r.cached ? '‚ö° (–∫—ç—à)' : ''} | –≤—Ä–µ–º—è: \${time}–º—Å\`
})

document.getElementById('calcAdd').addEventListener('click', () => {
  const a = +document.getElementById('a').value
  const b = +document.getElementById('b').value
  loggedAdd(a, b)
  if (logEl.children.length > 10) logEl.lastChild.remove()
})
`
  }}
  options={{ showNavigator: false, showLineNumbers: true, editorHeight: 400 }}
/>
