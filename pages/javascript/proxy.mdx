## JavaScript: Мозги - Урок "Proxy"


![Иллюстрация к уроку](/lessons/javascript-proxy.png)
Proxy в JavaScript - это мощный инструмент для перехвата и изменения базовых операций с объектами. Он позволяет нам контролировать доступ к свойствам, методы и другие аспекты объекта, открывая двери для гибкой настройки поведения.

### Концепция Proxy

Представьте себе Proxy как посредника между вами и объектом. Вы обращаетесь к объекту через Proxy, и Proxy решает, как обработать ваш запрос.  Это позволяет нам добавлять логику перед тем, как операции чтения, записи или удаления будут выполнены с исходным объектом.

```javascript
const target = {
  name: "Обычный Объект",
  age: 30
};

const handler = {
  get: function(target, property, receiver) {
    console.log(`Попытка чтения свойства: ${property}`);
    return Reflect.get(target, property, receiver); // Обязательно использовать Reflect
  },
  set: function(target, property, value, receiver) {
    console.log(`Попытка записи свойства: ${property} со значением: ${value}`);
    target[property] = value;
    return true; // Важно вернуть true при успешной записи
  }
};

const proxy = new Proxy(target, handler);

console.log(proxy.name); // Вывод: "Попытка чтения свойства: name", "Обычный Объект"
proxy.age = 35; // Вывод: "Попытка записи свойства: age со значением: 35"
console.log(target.age); // Вывод: 35 (значение в исходном объекте изменено)
```

В этом примере `handler` содержит методы `get` и `set`, которые перехватывают операции чтения и записи свойств.  `Reflect.get` и `Reflect.set` используются для корректного выполнения операций с исходным объектом. Важно использовать `Reflect`, чтобы избежать проблем с контекстом `this` и наследованием.

### Практические примеры кода

1.  **Валидация данных:**

```javascript
const validator = {
  set: function(obj, prop, value) {
    if (prop === 'age') {
      if (!Number.isInteger(value)) {
        throw new TypeError('Возраст должен быть числом');
      }
      if (value < 0) {
        throw new TypeError('Возраст не может быть отрицательным');
      }
    }

    obj[prop] = value;
    return true;
  }
};

const person = new Proxy({}, validator);

person.age = 30;
console.log(person.age); // 30

try {
  person.age = -10; // Выбросит ошибку
} catch (e) {
  console.error(e);
}
```

2.  **Логирование доступа к свойствам:**

```javascript
const logHandler = {
  get: function(target, property) {
    console.log(`Доступ к свойству: ${property}`);
    return target[property];
  }
};

const data = { name: "Иван", city: "Москва" };
const loggedData = new Proxy(data, logHandler);

console.log(loggedData.name); // Вывод: "Доступ к свойству: name", "Иван"
```

### Жизненный пример

Proxy активно используется во фреймворках, таких как Vue.js и MobX, для реализации реактивности. Они перехватывают изменения данных и автоматически обновляют пользовательский интерфейс.  Например, Vue.js использует Proxy (или Object.defineProperty в старых браузерах) для отслеживания изменений в данных компонента и перерисовки соответствующих частей DOM.

В некоторых библиотеках для работы с API Proxy используется для создания "ленивых" объектов, которые загружают данные только при первом обращении к ним.

### Ключевые моменты

*   Proxy позволяет перехватывать и изменять базовые операции с объектами.
*   `Reflect` используется для корректного выполнения операций с исходным объектом.
*   Proxy полезен для валидации данных, логирования, реактивности и других задач.
*   `get`, `set`, `deleteProperty`, `has`, `construct`, `apply` - это лишь некоторые из доступных обработчиков Proxy.
*   Не все браузеры поддерживают Proxy (особенно старые версии), поэтому необходимо учитывать совместимость.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proxy Пример</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Proxy Пример</h1>
    <p>Введите возраст:</p>
    <input type="number" id="ageInput">
    <button id="updateButton">Обновить возраст</button>
    <p id="output">Возраст: <span id="ageDisplay">Не задан</span></p>
    <p id="errorOutput" class="error"></p>
  </div>
  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #282c34;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}

input[type="number"] {
  padding: 8px;
  border-radius: 4px;
  border: 1px solid #555;
  background-color: #444;
  color: #fff;
  margin-bottom: 10px;
}

button {
  padding: 10px 20px;
  background-color: #61dafb;
  color: #282c34;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}

button:hover {
  background-color: #47bfe8;
}

.error {
  color: #ff6b6b;
  margin-top: 10px;
}`,
    "/index.js": `// Целевой объект
const person = {
  name: "Неизвестно",
  age: null
};

// Обработчик Proxy
const validator = {
  set: function(obj, prop, value) {
    if (prop === 'age') {
      if (!Number.isInteger(value)) {
        document.getElementById('errorOutput').textContent = 'Возраст должен быть целым числом.';
        return false; // Предотвращаем обновление
      }
      if (value < 0) {
        document.getElementById('errorOutput').textContent = 'Возраст не может быть отрицательным.';
        return false; // Предотвращаем обновление
      }
    }

    obj[prop] = value;
    document.getElementById('errorOutput').textContent = ''; // Очищаем сообщение об ошибке
    return true; // Разрешаем обновление
  }
};

// Создаем Proxy
const personProxy = new Proxy(person, validator);

// Получаем элементы DOM
const ageInput = document.getElementById('ageInput');
const updateButton = document.getElementById('updateButton');
const ageDisplay = document.getElementById('ageDisplay');

// Функция обновления возраста
function updateAge() {
  const newAge = parseInt(ageInput.value);

  if (personProxy.age = newAge) {
    ageDisplay.textContent = personProxy.age;
  }
}

// Обработчик клика на кнопку
updateButton.addEventListener('click', updateAge);

// Инициализация отображения возраста
ageDisplay.textContent = personProxy.age === null ? 'Не задан' : personProxy.age;
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
