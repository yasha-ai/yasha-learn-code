import { Sandpack } from '@codesandbox/sandpack-react'
## JavaScript: Мозги. Урок: Клонирование объектов (shallow vs deep)

Клонирование объектов в JavaScript – важная концепция, позволяющая создавать копии данных, не затрагивая оригинал. Понимание разницы между поверхностным и глубоким клонированием необходимо для избежания неожиданных ошибок и эффективной работы с данными.

### Что такое клонирование?

Клонирование – это процесс создания копии объекта.  В JavaScript объекты передаются по ссылке. Это означает, что если вы присваиваете один объект другому, вы фактически присваиваете ссылку на один и тот же участок памяти. Изменение одного объекта приведет к изменению другого. Клонирование позволяет создать независимую копию данных.

### Поверхностное клонирование (Shallow Copy)

Поверхностное клонирование создает новый объект, копируя значения свойств из исходного объекта. Если свойство является примитивным типом (число, строка, boolean), то копируется его значение. Если же свойство является объектом (массив, другой объект), то копируется *ссылка* на этот объект.

Пример:

```javascript
const originalObject = {
  name: 'John',
  age: 30,
  address: {
    city: 'New York'
  }
};

// Поверхностное клонирование с использованием оператора spread
const shallowCopy = { ...originalObject };

// Изменяем свойство в клоне
shallowCopy.name = 'Jane';
shallowCopy.address.city = 'Los Angeles';

console.log(originalObject.name); // John
console.log(originalObject.address.city); // Los Angeles - Вот тут проблема!
console.log(shallowCopy.name); // Jane
console.log(shallowCopy.address.city); // Los Angeles
```

В этом примере изменение `shallowCopy.name` не повлияло на `originalObject.name`, потому что `name` - это примитивный тип. Однако изменение `shallowCopy.address.city` повлияло на `originalObject.address.city`, потому что `address` - это объект, и была скопирована только ссылка на него.

Другие способы поверхностного клонирования:

*   `Object.assign({}, originalObject)`

### Глубокое клонирование (Deep Copy)

Глубокое клонирование создает новый объект и рекурсивно копирует *все* свойства исходного объекта, включая вложенные объекты. Таким образом, изменения во вложенных объектах клона не повлияют на исходный объект.

Пример:

```javascript
const originalObject = {
  name: 'John',
  age: 30,
  address: {
    city: 'New York'
  }
};

// Глубокое клонирование с использованием JSON.stringify и JSON.parse
const deepCopy = JSON.parse(JSON.stringify(originalObject));

// Изменяем свойство в клоне
deepCopy.name = 'Jane';
deepCopy.address.city = 'Los Angeles';

console.log(originalObject.name); // John
console.log(originalObject.address.city); // New York - Все хорошо!
console.log(deepCopy.name); // Jane
console.log(deepCopy.address.city); // Los Angeles
```

Этот метод работает, преобразуя объект в строку JSON, а затем обратно в объект.  Важно отметить, что этот метод не работает с функциями и циклическими ссылками.

Другие способы глубокого клонирования:

*   Использование библиотек, например Lodash (`_.cloneDeep(originalObject)`)
*   Рекурсивная функция клонирования (более сложный подход, но позволяет контролировать процесс)

### Жизненный пример

В React и других фреймворках часто используется клонирование объектов для обновления состояния компонента.  Необходимо создавать *новые* объекты состояния, а не изменять существующие, чтобы React мог обнаружить изменения и перерисовать компонент.

Например, при работе с массивом объектов в React:

```javascript
const [items, setItems] = React.useState([
  { id: 1, name: 'Apple' },
  { id: 2, name: 'Banana' }
]);

const updateItemName = (id, newName) => {
  // Создаем копию массива
  const newItems = items.map(item =>
    item.id === id ? { ...item, name: newName } : item
  );
  setItems(newItems);
};
```

Здесь используется поверхностное клонирование (`{ ...item, name: newName }`) для обновления одного элемента массива.  Важно создавать новые объекты, чтобы React корректно отслеживал изменения.

### Ключевые моменты

*   Объекты в JavaScript передаются по ссылке.
*   Поверхностное клонирование копирует значения примитивных типов и ссылки на объекты.
*   Глубокое клонирование копирует все свойства, включая вложенные объекты.
*   `JSON.stringify` и `JSON.parse` – простой способ глубокого клонирования, но он не работает с функциями и циклическими ссылками.
*   Библиотеки, такие как Lodash, предоставляют удобные функции для глубокого клонирования.
*   Клонирование важно для работы с состоянием в React и других фреймворках.

### Практика

Попробуйте примеры в интерактивном редакторе:

<Sandpack template="vanilla">

```js index.js
// Демонстрация клонирования объектов

document.body.style.fontFamily = 'Arial, sans-serif';
document.body.style.padding = '20px';
document.body.style.lineHeight = '1.6';

const title = document.createElement('h2');
title.textContent = 'Клонирование объектов: Shallow vs Deep';
document.body.appendChild(title);

// Исходный объект
const original = {
  name: 'Иван',
  age: 25,
  skills: ['JavaScript', 'React'],
  address: {
    city: 'Москва',
    street: 'Тверская'
  }
};

// === 1. Проблема: Присвоение по ссылке ===
const section1 = document.createElement('div');
section1.style.backgroundColor = '#ffebee';
section1.style.padding = '15px';
section1.style.borderRadius = '8px';
section1.style.marginBottom = '20px';

const h3_1 = document.createElement('h3');
h3_1.textContent = '1. ❌ Проблема: Присвоение по ссылке';
section1.appendChild(h3_1);

const refCopy = original;
refCopy.name = 'Петр';
refCopy.address.city = 'Санкт-Петербург';

const p1 = document.createElement('p');
p1.innerHTML = `
  <strong>Код:</strong> const refCopy = original;<br>
  refCopy.name = 'Петр';<br>
  refCopy.address.city = 'Санкт-Петербург';<br><br>
  
  <strong>original.name:</strong> ${original.name} ❌<br>
  <strong>original.address.city:</strong> ${original.address.city} ❌<br>
  <strong style="color: #f44336;">Оригинал изменился! Это ссылка, а не копия!</strong>
`;
section1.appendChild(p1);
document.body.appendChild(section1);

// Восстанавливаем оригинал
original.name = 'Иван';
original.address.city = 'Москва';

// === 2. Поверхностное клонирование ===
const section2 = document.createElement('div');
section2.style.backgroundColor = '#fff3e0';
section2.style.padding = '15px';
section2.style.borderRadius = '8px';
section2.style.marginBottom = '20px';

const h3_2 = document.createElement('h3');
h3_2.textContent = '2. ⚠️ Поверхностное клонирование (Shallow Copy)';
section2.appendChild(h3_2);

const shallowCopy = { ...original };
shallowCopy.name = 'Мария';
shallowCopy.skills.push('Vue'); // Массив тоже объект!
shallowCopy.address.city = 'Казань';

const p2 = document.createElement('p');
p2.innerHTML = `
  <strong>Код:</strong> const shallowCopy = { ...original };<br><br>
  
  <strong>Изменили:</strong><br>
  - shallowCopy.name = 'Мария'<br>
  - shallowCopy.skills.push('Vue')<br>
  - shallowCopy.address.city = 'Казань'<br><br>
  
  <strong>original.name:</strong> ${original.name} ✅ (не изменилось)<br>
  <strong>original.skills:</strong> [${original.skills}] ❌ (изменилось!)<br>
  <strong>original.address.city:</strong> ${original.address.city} ❌ (изменилось!)<br><br>
  
  <strong style="color: #FF9800;">Примитивы скопировались, а вложенные объекты - нет!</strong>
`;
section2.appendChild(p2);
document.body.appendChild(section2);

// Восстанавливаем оригинал
original.skills = ['JavaScript', 'React'];
original.address.city = 'Москва';

// === 3. Глубокое клонирование ===
const section3 = document.createElement('div');
section3.style.backgroundColor = '#e8f5e9';
section3.style.padding = '15px';
section3.style.borderRadius = '8px';
section3.style.marginBottom = '20px';

const h3_3 = document.createElement('h3');
h3_3.textContent = '3. ✅ Глубокое клонирование (Deep Copy)';
section3.appendChild(h3_3);

const deepCopy = JSON.parse(JSON.stringify(original));
deepCopy.name = 'Анна';
deepCopy.skills.push('Angular');
deepCopy.address.city = 'Екатеринбург';

const p3 = document.createElement('p');
p3.innerHTML = `
  <strong>Код:</strong> const deepCopy = JSON.parse(JSON.stringify(original));<br><br>
  
  <strong>Изменили:</strong><br>
  - deepCopy.name = 'Анна'<br>
  - deepCopy.skills.push('Angular')<br>
  - deepCopy.address.city = 'Екатеринбург'<br><br>
  
  <strong>original.name:</strong> ${original.name} ✅<br>
  <strong>original.skills:</strong> [${original.skills}] ✅<br>
  <strong>original.address.city:</strong> ${original.address.city} ✅<br><br>
  
  <strong style="color: #4CAF50;">Все изменения только в копии! Оригинал не тронут!</strong>
`;
section3.appendChild(p3);
document.body.appendChild(section3);

// === 4. Сравнение методов ===
const section4 = document.createElement('div');
section4.style.backgroundColor = '#e3f2fd';
section4.style.padding = '15px';
section4.style.borderRadius = '8px';

const h3_4 = document.createElement('h3');
h3_4.textContent = '4. Сравнение методов';
section4.appendChild(h3_4);

const table = document.createElement('table');
table.style.borderCollapse = 'collapse';
table.style.width = '100%';

table.innerHTML = `
  <thead>
    <tr style="background: #2196F3; color: white;">
      <th style="border: 1px solid #ddd; padding: 10px;">Метод</th>
      <th style="border: 1px solid #ddd; padding: 10px;">Примитивы</th>
      <th style="border: 1px solid #ddd; padding: 10px;">Вложенные объекты</th>
      <th style="border: 1px solid #ddd; padding: 10px;">Функции</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border: 1px solid #ddd; padding: 8px;">= (присвоение)</td>
      <td style="border: 1px solid #ddd; padding: 8px;">❌ Ссылка</td>
      <td style="border: 1px solid #ddd; padding: 8px;">❌ Ссылка</td>
      <td style="border: 1px solid #ddd; padding: 8px;">❌ Ссылка</td>
    </tr>
    <tr>
      <td style="border: 1px solid #ddd; padding: 8px;">{ ...obj }</td>
      <td style="border: 1px solid #ddd; padding: 8px;">✅ Копия</td>
      <td style="border: 1px solid #ddd; padding: 8px;">❌ Ссылка</td>
      <td style="border: 1px solid #ddd; padding: 8px;">✅ Копия</td>
    </tr>
    <tr>
      <td style="border: 1px solid #ddd; padding: 8px;">Object.assign()</td>
      <td style="border: 1px solid #ddd; padding: 8px;">✅ Копия</td>
      <td style="border: 1px solid #ddd; padding: 8px;">❌ Ссылка</td>
      <td style="border: 1px solid #ddd; padding: 8px;">✅ Копия</td>
    </tr>
    <tr>
      <td style="border: 1px solid #ddd; padding: 8px;">JSON.parse(stringify)</td>
      <td style="border: 1px solid #ddd; padding: 8px;">✅ Копия</td>
      <td style="border: 1px solid #ddd; padding: 8px;">✅ Копия</td>
      <td style="border: 1px solid #ddd; padding: 8px;">❌ Теряются</td>
    </tr>
    <tr>
      <td style="border: 1px solid #ddd; padding: 8px;">structuredClone()</td>
      <td style="border: 1px solid #ddd; padding: 8px;">✅ Копия</td>
      <td style="border: 1px solid #ddd; padding: 8px;">✅ Копия</td>
      <td style="border: 1px solid #ddd; padding: 8px;">❌ Теряются</td>
    </tr>
  </tbody>
`;
section4.appendChild(table);

const note = document.createElement('p');
note.innerHTML = `
  <strong>Рекомендация:</strong><br>
  • Для простых объектов: <code>{ ...obj }</code><br>
  • Для вложенных объектов: <code>structuredClone(obj)</code> (современный браузер)<br>
  • Для сложных случаев: Lodash <code>_.cloneDeep(obj)</code>
`;
note.style.marginTop = '15px';
section4.appendChild(note);

document.body.appendChild(section4);

console.log('Демонстрация клонирования завершена!');
```

</Sandpack>
