## JavaScript: Мозги. Урок: Клонирование объектов (shallow vs deep)


![Иллюстрация к уроку](/lessons/javascript-object-cloning.png)
Клонирование объектов в JavaScript – важная концепция, позволяющая создавать копии данных, не затрагивая оригинал. Понимание разницы между поверхностным и глубоким клонированием необходимо для избежания неожиданных ошибок и эффективной работы с данными.

### Что такое клонирование?

Клонирование – это процесс создания копии объекта.  В JavaScript объекты передаются по ссылке. Это означает, что если вы присваиваете один объект другому, вы фактически присваиваете ссылку на один и тот же участок памяти. Изменение одного объекта приведет к изменению другого. Клонирование позволяет создать независимую копию данных.

### Поверхностное клонирование (Shallow Copy)

Поверхностное клонирование создает новый объект, копируя значения свойств из исходного объекта. Если свойство является примитивным типом (число, строка, boolean), то копируется его значение. Если же свойство является объектом (массив, другой объект), то копируется *ссылка* на этот объект.

Пример:

```javascript
const originalObject = {
  name: 'John',
  age: 30,
  address: {
    city: 'New York'
  }
};

// Поверхностное клонирование с использованием оператора spread
const shallowCopy = { ...originalObject };

// Изменяем свойство в клоне
shallowCopy.name = 'Jane';
shallowCopy.address.city = 'Los Angeles';

console.log(originalObject.name); // John
console.log(originalObject.address.city); // Los Angeles - Вот тут проблема!
console.log(shallowCopy.name); // Jane
console.log(shallowCopy.address.city); // Los Angeles
```

В этом примере изменение `shallowCopy.name` не повлияло на `originalObject.name`, потому что `name` - это примитивный тип. Однако изменение `shallowCopy.address.city` повлияло на `originalObject.address.city`, потому что `address` - это объект, и была скопирована только ссылка на него.

Другие способы поверхностного клонирования:

*   `Object.assign({}, originalObject)`

### Глубокое клонирование (Deep Copy)

Глубокое клонирование создает новый объект и рекурсивно копирует *все* свойства исходного объекта, включая вложенные объекты. Таким образом, изменения во вложенных объектах клона не повлияют на исходный объект.

Пример:

```javascript
const originalObject = {
  name: 'John',
  age: 30,
  address: {
    city: 'New York'
  }
};

// Глубокое клонирование с использованием JSON.stringify и JSON.parse
const deepCopy = JSON.parse(JSON.stringify(originalObject));

// Изменяем свойство в клоне
deepCopy.name = 'Jane';
deepCopy.address.city = 'Los Angeles';

console.log(originalObject.name); // John
console.log(originalObject.address.city); // New York - Все хорошо!
console.log(deepCopy.name); // Jane
console.log(deepCopy.address.city); // Los Angeles
```

Этот метод работает, преобразуя объект в строку JSON, а затем обратно в объект.  Важно отметить, что этот метод не работает с функциями и циклическими ссылками.

Другие способы глубокого клонирования:

*   Использование библиотек, например Lodash (`_.cloneDeep(originalObject)`)
*   Рекурсивная функция клонирования (более сложный подход, но позволяет контролировать процесс)

### Жизненный пример

В React и других фреймворках часто используется клонирование объектов для обновления состояния компонента.  Необходимо создавать *новые* объекты состояния, а не изменять существующие, чтобы React мог обнаружить изменения и перерисовать компонент.

Например, при работе с массивом объектов в React:

```javascript
const [items, setItems] = React.useState([
  { id: 1, name: 'Apple' },
  { id: 2, name: 'Banana' }
]);

const updateItemName = (id, newName) => {
  // Создаем копию массива
  const newItems = items.map(item =>
    item.id === id ? { ...item, name: newName } : item
  );
  setItems(newItems);
};
```

Здесь используется поверхностное клонирование (`{ ...item, name: newName }`) для обновления одного элемента массива.  Важно создавать новые объекты, чтобы React корректно отслеживал изменения.

### Ключевые моменты

*   Объекты в JavaScript передаются по ссылке.
*   Поверхностное клонирование копирует значения примитивных типов и ссылки на объекты.
*   Глубокое клонирование копирует все свойства, включая вложенные объекты.
*   `JSON.stringify` и `JSON.parse` – простой способ глубокого клонирования, но он не работает с функциями и циклическими ссылками.
*   Библиотеки, такие как Lodash, предоставляют удобные функции для глубокого клонирования.
*   Клонирование важно для работы с состоянием в React и других фреймворках.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Клонирование объектов</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Клонирование объектов (Shallow vs Deep)</h1>

    <div id="original">
      <h2>Исходный объект:</h2>
      <pre id="original-data"></pre>
    </div>

    <div id="shallow">
      <h2>Поверхностная копия:</h2>
      <pre id="shallow-data"></pre>
    </div>

    <div id="deep">
      <h2>Глубокая копия:</h2>
      <pre id="deep-data"></pre>
    </div>

    <div>
      <label for="name-input">Изменить имя:</label>
      <input type="text" id="name-input" value="John">
      <button id="update-name">Обновить имя</button>
    </div>

    <div>
      <label for="city-input">Изменить город:</label>
      <input type="text" id="city-input" value="New York">
      <button id="update-city">Обновить город</button>
    </div>
  </div>

  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: 0 auto;
}

pre {
  background-color: #333;
  padding: 10px;
  border-radius: 5px;
  overflow-x: auto;
}

input[type="text"] {
  padding: 5px;
  margin-right: 10px;
  background-color: #444;
  color: #eee;
  border: none;
  border-radius: 3px;
}

button {
  padding: 5px 10px;
  background-color: #555;
  color: #eee;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

button:hover {
  background-color: #777;
}`,
    "/index.js": `// Исходный объект
const originalObject = {
  name: 'John',
  age: 30,
  address: {
    city: 'New York'
  }
};

// Поверхностное клонирование
const shallowCopy = { ...originalObject };

// Глубокое клонирование
const deepCopy = JSON.parse(JSON.stringify(originalObject));

// Функция для отображения объекта в pre
function displayObject(elementId, obj) {
  document.getElementById(elementId).textContent = JSON.stringify(obj, null, 2);
}

// Отображаем исходные данные
displayObject('original-data', originalObject);
displayObject('shallow-data', shallowCopy);
displayObject('deep-data', deepCopy);

// Обработчик кнопки обновления имени
document.getElementById('update-name').addEventListener('click', () => {
  const newName = document.getElementById('name-input').value;

  // Обновляем имя в клонах
  shallowCopy.name = newName;
  deepCopy.name = newName;

  // Отображаем обновленные данные
  displayObject('shallow-data', shallowCopy);
  displayObject('deep-data', deepCopy);
  displayObject('original-data', originalObject); // Покажем, что original не меняется
});

// Обработчик кнопки обновления города
document.getElementById('update-city').addEventListener('click', () => {
  const newCity = document.getElementById('city-input').value;

  // Обновляем город в клонах
  shallowCopy.address.city = newCity;
  deepCopy.address.city = newCity;

  // Отображаем обновленные данные
  displayObject('shallow-data', shallowCopy);
  displayObject('deep-data', deepCopy);
  displayObject('original-data', originalObject); // Покажем, что original меняется в shallow copy
});
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
