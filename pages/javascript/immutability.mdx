## JavaScript: Мозги. Урок: Иммутабельность


![Иллюстрация к уроку](/lessons/javascript-immutability.png)
Иммутабельность – это краеугольный камень надежного и предсказуемого кода. В этом уроке мы разберем, что такое иммутабельность, зачем она нужна и как ее реализовать в JavaScript.

### Что такое иммутабельность?

Иммутабельность означает, что после создания объект не может быть изменен. Вместо изменения существующего объекта, создается его новая копия с нужными изменениями. Представьте себе, что у вас есть лего-конструктор. Вместо того, чтобы ломать собранную фигуру и перестраивать ее, вы берете новые детали и строите новую фигуру, основываясь на старой.

### Иммутабельность на практике

#### Работа с примитивами

Примитивные типы данных в JavaScript (строки, числа, булевы значения, null, undefined, Symbol) уже иммутабельны. Их значения нельзя изменить.

```javascript
let str = "Hello";
str = str.toUpperCase(); // str теперь "HELLO", исходная строка "Hello" не изменилась, создана новая.

let num = 5;
num = num + 2; // num теперь 7, исходное значение 5 не изменилось.
```

#### Работа с объектами и массивами

С объектами и массивами все сложнее, так как они по умолчанию мутабельны (изменяемые).

```javascript
let person = { name: "Alice", age: 30 };
person.age = 31; // Мутация объекта person

let numbers = [1, 2, 3];
numbers.push(4); // Мутация массива numbers
```

Чтобы работать с объектами и массивами иммутабельно, нужно создавать их копии.

```javascript
// Иммутабельное обновление объекта с использованием spread syntax
let person = { name: "Alice", age: 30 };
let updatedPerson = { ...person, age: 31 }; // Создается новый объект, age обновляется

// Иммутабельное обновление массива с использованием slice и spread syntax
let numbers = [1, 2, 3];
let updatedNumbers = [...numbers, 4]; // Создается новый массив, добавляется элемент
let removedNumbers = numbers.slice(0, 2); // Создается новый массив с первыми двумя элементами

//Альтернативный вариант для массивов: map, filter, reduce
let doubledNumbers = numbers.map(x => x * 2); // [2, 4, 6] - новый массив
```

### Зачем нужна иммутабельность?

*   **Предсказуемость:** Легче понимать, как изменяются данные в вашем приложении.
*   **Отладка:** Проще отслеживать источник ошибок, так как изменения данных происходят более контролируемо.
*   **Оптимизация:** В некоторых случаях иммутабельность позволяет оптимизировать производительность, например, в React.
*   **Параллелизм:** Иммутабельные структуры данных безопасны для использования в многопоточных приложениях.

### Жизненный пример

В React, Redux и других фреймворках и библиотеках иммутабельность играет ключевую роль. Например, в Redux состояние приложения хранится в иммутабельном виде. При каждом изменении состояния создается новый объект состояния, что позволяет React эффективно обнаруживать изменения и перерисовывать только необходимые компоненты. Это значительно повышает производительность. Многие библиотеки для работы с данными, такие как Immutable.js, предоставляют инструменты для упрощения работы с иммутабельными структурами данных.

### Ключевые моменты

*   Иммутабельность – это концепция, при которой данные не могут быть изменены после создания.
*   Примитивные типы в JavaScript иммутабельны.
*   Объекты и массивы по умолчанию мутабельны, поэтому необходимо создавать их копии для иммутабельного обновления.
*   Иммутабельность упрощает отладку, повышает предсказуемость и может улучшить производительность.
*   Фреймворки, такие как React и Redux, активно используют иммутабельность.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html>
<head>
  <title>Immutability Example</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <h1>Immutability in JavaScript</h1>

  <div id="app">
    <h2>Person Details</h2>
    <p>Name: <span id="personName"></span></p>
    <p>Age: <span id="personAge"></span></p>

    <button id="updateAgeBtn">Increment Age (Immutably)</button>

    <h2>Numbers Array</h2>
    <p>Original: <span id="originalNumbers"></span></p>
    <p>Doubled: <span id="doubledNumbers"></span></p>

    <input type="number" id="addNumberInput" placeholder="Enter a number">
    <button id="addNumberBtn">Add Number (Immutably)</button>
    <p>Updated Array: <span id="updatedNumbers"></span></p>
  </div>

  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  padding: 20px;
}

#app {
  background-color: #333;
  padding: 20px;
  border-radius: 5px;
}

button {
  background-color: #4CAF50;
  border: none;
  color: white;
  padding: 10px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 5px;
}

input[type=number] {
  padding: 8px;
  margin: 5px;
  border-radius: 4px;
  border: 1px solid #ccc;
}
`,
    "/index.js": `// Исходный объект person
let person = { name: "Alice", age: 30 };

// Функция для обновления возраста иммутабельно
function incrementAge(person) {
  return { ...person, age: person.age + 1 };
}

// Исходный массив чисел
let numbers = [1, 2, 3];

// Функция для удвоения чисел иммутабельно
function doubleNumbers(numbers) {
  return numbers.map(x => x * 2);
}

// Функция для добавления числа в массив иммутабельно
function addNumber(numbers, newNumber) {
  return [...numbers, newNumber];
}

// Обновляем отображение информации о person
function updatePersonDisplay(person) {
  document.getElementById("personName").textContent = person.name;
  document.getElementById("personAge").textContent = person.age;
}

// Обновляем отображение массивов
function updateNumbersDisplay(numbers, doubled, updated) {
  document.getElementById("originalNumbers").textContent = JSON.stringify(numbers);
  document.getElementById("doubledNumbers").textContent = JSON.stringify(doubled);
  document.getElementById("updatedNumbers").textContent = JSON.stringify(updated);
}

// Инициализация отображения
updatePersonDisplay(person);
const doubledNumbers = doubleNumbers(numbers);
updateNumbersDisplay(numbers, doubledNumbers, numbers);

// Обработчик кнопки для увеличения возраста
document.getElementById("updateAgeBtn").addEventListener("click", () => {
  person = incrementAge(person); // Обновляем person иммутабельно
  updatePersonDisplay(person);
});

// Обработчик кнопки для добавления числа
document.getElementById("addNumberBtn").addEventListener("click", () => {
  const newNumber = parseInt(document.getElementById("addNumberInput").value);
  if (!isNaN(newNumber)) {
    numbers = addNumber(numbers, newNumber); // Обновляем numbers иммутабельно
    const doubled = doubleNumbers(numbers);
    updateNumbersDisplay(numbers, doubled, numbers);
    document.getElementById("addNumberInput").value = ""; // Очищаем поле ввода
  } else {
    alert("Please enter a valid number.");
  }
});
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
