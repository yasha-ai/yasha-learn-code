## JavaScript: Мозги. Урок: Service Workers


![Иллюстрация к уроку](/lessons/javascript-service-workers.png)
Service Workers - это мощный инструмент JavaScript, позволяющий сделать ваши веб-приложения быстрее, надежнее и способными работать в оффлайн-режиме. По сути, это скрипт, который работает в фоновом режиме, независимо от вашей веб-страницы.

### Что такое Service Worker?

Представьте Service Worker как посредника между вашим веб-приложением, браузером и сетью. Он перехватывает сетевые запросы, управляет кешем и может даже отправлять push-уведомления.  Он работает в отдельном потоке, поэтому не блокирует основной поток вашего приложения, обеспечивая плавную работу интерфейса.

### Регистрация Service Worker

Прежде чем использовать Service Worker, его необходимо зарегистрировать. Это делается в основном скрипте вашего приложения.

```javascript
// index.js
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js') // Путь к вашему service worker файлу
    .then(registration => {
      console.log('Service Worker зарегистрирован успешно:', registration);
    })
    .catch(error => {
      console.log('Ошибка при регистрации Service Worker:', error);
    });
}
```

Этот код проверяет, поддерживает ли браузер Service Workers, и регистрирует `/sw.js`.

### sw.js: Жизненный цикл Service Worker

Файл `sw.js` содержит логику вашего Service Worker.  Основные этапы жизненного цикла:

1.  **Install:**  Выполняется один раз при первой установке Service Worker.  Здесь обычно происходит кеширование статических ресурсов.

```javascript
// sw.js
const CACHE_NAME = 'my-site-cache-v1';
const urlsToCache = [
  '/',
  '/index.html',
  '/styles.css',
  '/script.js'
];

self.addEventListener('install', function(event) {
  // Выполняется при установке Service Worker
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(function(cache) {
        console.log('Открыт кеш:', CACHE_NAME);
        return cache.addAll(urlsToCache); // Кешируем ресурсы
      })
  );
});
```

2.  **Activate:** Выполняется после установки.  Здесь часто происходит очистка старого кеша.

```javascript
self.addEventListener('activate', function(event) {
  // Выполняется при активации Service Worker
  event.waitUntil(
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        cacheNames.map(function(cacheName) {
          if (cacheName !== CACHE_NAME) {
            console.log('Удаляем старый кеш:', cacheName);
            return caches.delete(cacheName); // Удаляем старый кеш
          }
        })
      );
    })
  );
});
```

3.  **Fetch:** Перехватывает сетевые запросы.  Здесь вы можете вернуть данные из кеша или запросить их из сети.

```javascript
self.addEventListener('fetch', function(event) {
  // Перехватываем сетевые запросы
  event.respondWith(
    caches.match(event.request) // Проверяем, есть ли запрос в кеше
      .then(function(response) {
        // Если есть в кеше, возвращаем его
        if (response) {
          return response;
        }

        // Если нет в кеше, делаем запрос в сеть
        return fetch(event.request).then(
          function(response) {
            // Проверяем, что ответ корректный
            if(!response || response.status !== 200 || response.type !== 'basic') {
              return response;
            }

            // Клонируем ответ (потому что он может быть использован только один раз)
            var responseToCache = response.clone();

            caches.open(CACHE_NAME)
              .then(function(cache) {
                cache.put(event.request, responseToCache); // Кешируем ответ
              });

            return response;
          }
        );
      })
    );
});
```

### Жизненный пример

Многие современные веб-приложения и сайты используют Service Workers для повышения производительности и обеспечения оффлайн-доступа.  Например:

*   **Progressive Web Apps (PWAs):** Service Workers являются ключевой технологией для создания PWAs, позволяя им работать как нативные приложения.
*   **Google Maps:** Использует Service Workers для кеширования карт, позволяя пользователям просматривать карты даже без подключения к интернету.
*   **Новостные сайты:** Могут кешировать статьи для чтения в оффлайн-режиме.
*   **Фреймворки (например, React, Angular, Vue):**  Имеют встроенные инструменты или библиотеки для работы с Service Workers.  Например, `create-react-app` часто содержит `service-worker.js` по умолчанию.

### Ключевые моменты

*   Service Workers работают в отдельном потоке.
*   Они имеют доступ к Cache API для хранения ресурсов.
*   Они могут перехватывать и обрабатывать сетевые запросы.
*   Они позволяют создавать веб-приложения, работающие в оффлайн-режиме.
*   Важно понимать жизненный цикл Service Worker (install, activate, fetch).
*   При обновлении Service Worker важно очищать старый кеш.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Worker Demo</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Service Worker Demo</h1>
    <p>Это простое веб-приложение, демонстрирующее работу Service Worker.</p>
    <button id="cacheButton">Кешировать изображение</button>
    <img id="cachedImage" src="" alt="Cached Image" style="display: none; max-width: 200px;">
    <p id="status">Service Worker не активен.</p>
  </div>
  <script src="/index.js"></script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}

button {
  background-color: #4CAF50;
  border: none;
  color: white;
  padding: 10px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 4px;
}

button:hover {
  background-color: #3e8e41;
}`,
    "/index.js": `// index.js
const cacheButton = document.getElementById('cacheButton');
const cachedImage = document.getElementById('cachedImage');
const status = document.getElementById('status');

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(registration => {
      console.log('Service Worker зарегистрирован успешно:', registration);
      status.textContent = 'Service Worker активен!';
    })
    .catch(error => {
      console.log('Ошибка при регистрации Service Worker:', error);
      status.textContent = 'Ошибка регистрации Service Worker.';
    });
} else {
  status.textContent = 'Service Worker не поддерживается вашим браузером.';
}

cacheButton.addEventListener('click', () => {
  caches.open('my-image-cache')
    .then(cache => {
      return cache.add('https://via.placeholder.com/150'); // URL изображения для кеширования
    })
    .then(() => {
      console.log('Изображение закешировано!');
      cachedImage.src = 'https://via.placeholder.com/150';
      cachedImage.style.display = 'block';
    });
});`,
    "/sw.js": `// sw.js
const CACHE_NAME = 'my-site-cache-v1';
const urlsToCache = [
  '/',
  '/index.html',
  '/styles.css',
  '/index.js'
];

self.addEventListener('install', function(event) {
  // Выполняется при установке Service Worker
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(function(cache) {
        console.log('Открыт кеш:', CACHE_NAME);
        return cache.addAll(urlsToCache); // Кешируем основные ресурсы
      })
  );
});

self.addEventListener('activate', function(event) {
  // Выполняется при активации Service Worker
  event.waitUntil(
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        cacheNames.map(function(cacheName) {
          if (cacheName !== CACHE_NAME) {
            console.log('Удаляем старый кеш:', cacheName);
            return caches.delete(cacheName); // Удаляем старый кеш
          }
        })
      );
    })
  );
});

self.addEventListener('fetch', function(event) {
  // Перехватываем сетевые запросы
  event.respondWith(
    caches.match(event.request) // Проверяем, есть ли запрос в кеше
      .then(function(response) {
        // Если есть в кеше, возвращаем его
        if (response) {
          return response;
        }

        // Если нет в кеше, делаем запрос к сети
        return fetch(event.request).then(
          function(response) {
            // Проверяем, что получили корректный ответ
            if(!response || response.status !== 200 || response.type !== 'basic') {
              return response;
            }

            // Клонируем ответ.  Ответ можно использовать только один раз.
            var responseToCache = response.clone();

            caches.open(CACHE_NAME)
              .then(function(cache) {
                cache.put(event.request, responseToCache);
              });

            return response;
          }
        );
      })
    );
});`
  }}
  options={{
    showNavigator: true,
    showLineNumbers: true,
    editorHeight: 400,
    previewHeight: 300
  }}
/>
