# JavaScript: Мозги. Async Error Handling


![Иллюстрация к уроку](/lessons/javascript-async-error-handling.png)
В этом уроке мы разберем, как правильно обрабатывать ошибки в асинхронном JavaScript коде. Некорректная обработка ошибок может привести к неожиданному поведению вашего приложения и усложнить отладку.

## Что такое Async Error Handling?

Async Error Handling – это набор техник и практик, которые позволяют нам предвидеть и обрабатывать ошибки, которые могут возникнуть в асинхронном коде. Асинхронный код, как правило, включает в себя работу с Promises, `async/await`, `setTimeout`, `setInterval` и другими функциями, которые не блокируют основной поток выполнения. Обработка ошибок в таком коде требует особого подхода, поскольку обычные блоки `try...catch` не всегда работают, как ожидается.

## Promises и Error Handling

Promises предоставляют два основных способа обработки ошибок: `.catch()` и второй аргумент в `.then()`.

```javascript
function fetchData() {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      const success = Math.random() > 0.5; // Имитируем успешное или неудачное выполнение
      if (success) {
        resolve("Данные успешно получены!");
      } else {
        reject("Ошибка при получении данных!");
      }
    }, 1000);
  });
}

fetchData()
  .then(data => {
    console.log(data);
  })
  .catch(error => {
    console.error("Произошла ошибка:", error);
  });
```

В этом примере `.catch()` перехватывает любую ошибку, возникшую в цепочке Promise.

Также можно использовать второй аргумент `.then()`:

```javascript
fetchData()
  .then(
    data => { console.log(data); },
    error => { console.error("Произошла ошибка:", error); }
  );
```

Однако, `.catch()` предпочтительнее, так как он позволяет перехватывать ошибки, возникающие *внутри* обработчика `.then()`.

## Async/Await и Error Handling

`async/await` делает асинхронный код более читаемым и похожим на синхронный. Для обработки ошибок в `async/await` мы используем `try...catch`.

```javascript
async function getData() {
  try {
    const data = await fetchData();
    console.log("Данные получены:", data);
  } catch (error) {
    console.error("Произошла ошибка:", error);
  }
}

getData();
```

В этом примере, если `fetchData()` отклонит Promise (вызовет `reject`), `catch` блок перехватит ошибку.

## Жизненный пример

Представьте, что вы работаете над веб-приложением, которое отображает данные о погоде, полученные с внешнего API.

```javascript
async function displayWeather(city) {
  try {
    const response = await fetch(`https://api.example.com/weather?city=${city}`); // Замените на реальный API
    if (!response.ok) {
      throw new Error(`Ошибка HTTP: ${response.status}`);
    }
    const data = await response.json();
    document.getElementById("weather-info").textContent = `Температура в ${city}: ${data.temperature}°C`;
  } catch (error) {
    console.error("Ошибка при получении данных о погоде:", error);
    document.getElementById("weather-info").textContent = "Не удалось получить данные о погоде.";
  }
}

// Вызов функции
displayWeather("London");
```

В этом примере мы используем `try...catch` для обработки ошибок, которые могут возникнуть при запросе к API (например, сетевая ошибка, неверный URL или ошибка сервера).  Если происходит ошибка, мы выводим сообщение об ошибке в консоль и отображаем информативное сообщение пользователю на странице. Многие современные JavaScript фреймворки, такие как React, Vue и Angular, активно используют `async/await` и `try/catch` для обработки ошибок при работе с API.

## Ключевые моменты

*   Используйте `.catch()` для обработки ошибок в цепочках Promise.
*   Используйте `try...catch` для обработки ошибок в функциях `async/await`.
*   Всегда обрабатывайте ошибки в асинхронном коде, чтобы предотвратить неожиданное поведение приложения.
*   Предоставляйте информативные сообщения об ошибках пользователю.
*   Не забывайте логировать ошибки для облегчения отладки.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Async Error Handling</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Погода здесь и сейчас</h1>
    <label for="cityInput">Введите название города:</label>
    <input type="text" id="cityInput" placeholder="Например, Москва">
    <button id="getWeatherBtn">Узнать погоду</button>
    <div id="weather-info"></div>
    <div id="error-message"></div>
  </div>
  <script src="/index.js"><\/script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  width: 400px;
  text-align: center;
}

input[type="text"] {
  padding: 8px;
  margin: 10px 0;
  width: 100%;
  box-sizing: border-box;
  border: 1px solid #555;
  background-color: #444;
  color: #eee;
  border-radius: 4px;
}

button {
  background-color: #5cb85c;
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}

button:hover {
  background-color: #449d44;
}

#weather-info {
  margin-top: 20px;
  font-size: 1.2em;
}

#error-message {
  color: #d9534f;
  margin-top: 10px;
}`,
    "/index.js": `// Функция для имитации запроса к API
async function getWeatherData(city) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      // Имитируем успешный или неудачный ответ
      const isSuccess = Math.random() > 0.2; // Увеличили шанс успеха
      if (isSuccess) {
        const temperature = Math.floor(Math.random() * 30); // Случайная температура
        resolve({ city: city, temperature: temperature });
      } else {
        reject(new Error(\`Не удалось получить данные о погоде для города \${'}city'}\`));
      }
    }, 500); // Задержка в полсекунды
  });
}

// Функция для отображения данных о погоде
async function displayWeather(city) {
  const weatherInfoDiv = document.getElementById("weather-info");
  const errorMessageDiv = document.getElementById("error-message");

  weatherInfoDiv.textContent = ""; // Очищаем предыдущие данные
  errorMessageDiv.textContent = ""; // Очищаем сообщения об ошибках

  try {
    const weatherData = await getWeatherData(city);
    weatherInfoDiv.textContent = \`Температура в \${'}weatherData.city'}: \${'}weatherData.temperature'}°C\`;
  } catch (error) {
    console.error("Ошибка при получении данных о погоде:", error);
    errorMessageDiv.textContent = error.message;
  }
}

// Обработчик события для кнопки
document.getElementById("getWeatherBtn").addEventListener("click", () => {
  const city = document.getElementById("cityInput").value;
  if (city) {
    displayWeather(city);
  } else {
    document.getElementById("error-message").textContent = "Пожалуйста, введите название города.";
  }
});`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
