import { Sandpack } from '@codesandbox/sandpack-react'

# –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π (Event Delegation) ‚Äî —Ç–µ—Ö–Ω–∏–∫–∞, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ **—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç** –≤–º–µ—Å—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–æ—á–µ—Ä–Ω–∏–π. –†–∞–±–æ—Ç–∞–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è –º–µ—Ö–∞–Ω–∏–∑–º—É **–≤—Å–ø–ª—ã—Ç–∏—è —Å–æ–±—ã—Ç–∏–π** (bubbling).

## –í—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏–π (Event Bubbling)

–ö–æ–≥–¥–∞ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–µ, –æ–Ω–æ ¬´–≤—Å–ø–ª—ã–≤–∞–µ—Ç¬ª –≤–≤–µ—Ä—Ö –ø–æ DOM-–¥–µ—Ä–µ–≤—É:

```
span ‚Üí li ‚Üí ul ‚Üí div ‚Üí body ‚Üí html ‚Üí document ‚Üí window
```

```javascript
document.querySelector('ul').addEventListener('click', (e) => {
  // e.target ‚Äî —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –ø—Ä–æ–∏–∑–æ—à—ë–ª –∫–ª–∏–∫
  // e.currentTarget ‚Äî —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤–∏—Å–∏—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (ul)
  console.log('target:', e.target.tagName)
  console.log('currentTarget:', e.currentTarget.tagName)
})

// –ö–ª–∏–∫ –Ω–∞ li ‚Üí —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ul!
// –ö–ª–∏–∫ –Ω–∞ span –≤–Ω—É—Ç—Ä–∏ li ‚Üí —Ç–æ–∂–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç!
```

## –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```javascript
// ‚ùå –ü–ª–æ—Ö–æ: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç
const items = document.querySelectorAll('.item')
items.forEach(item => {
  item.addEventListener('click', handleClick) // N –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤!
})

// –ü—Ä–æ–±–ª–µ–º—ã:
// 1. –ú–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ = –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏
// 2. –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é
// 3. –°–ª–æ–∂–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

// ‚úÖ –•–æ—Ä–æ—à–æ: –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ
document.querySelector('.list').addEventListener('click', handleClick)
// –†–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö, –∏ –¥–ª—è –±—É–¥—É—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤!
```

## –ë–∞–∑–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```javascript
const list = document.querySelector('#todo-list')

list.addEventListener('click', function(event) {
  // –ò—â–µ–º –Ω—É–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç —á–µ—Ä–µ–∑ closest()
  const item = event.target.closest('.todo-item')
  if (!item) return // –∫–ª–∏–∫ –±—ã–ª –Ω–µ –Ω–∞ todo-item

  const deleteBtn = event.target.closest('.delete-btn')
  const checkbox = event.target.closest('input[type="checkbox"]')
  
  if (deleteBtn) {
    item.remove()
  } else if (checkbox) {
    item.classList.toggle('completed', checkbox.checked)
  }
})
```

## event.target.closest() ‚Äî –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç

`closest(selector)` –∏—â–µ—Ç –±–ª–∏–∂–∞–π—à–µ–≥–æ –ø—Ä–µ–¥–∫–∞ (–≤–∫–ª—é—á–∞—è —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç), —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å–µ–ª–µ–∫—Ç–æ—Ä—É:

```javascript
document.addEventListener('click', (e) => {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø–æ data-–∞—Ç—Ä–∏–±—É—Ç—É
  const button = e.target.closest('[data-action]')
  if (!button) return

  const action = button.dataset.action
  const id = button.dataset.id

  switch (action) {
    case 'edit':   editItem(id); break
    case 'delete': deleteItem(id); break
    case 'toggle': toggleItem(id); break
  }
})

// HTML:
// <button data-action="delete" data-id="42">–£–¥–∞–ª–∏—Ç—å</button>
// <button data-action="edit" data-id="42">–ò–∑–º–µ–Ω–∏—Ç—å</button>
```

## –ü–∞—Ç—Ç–µ—Ä–Ω: data-–∞—Ç—Ä–∏–±—É—Ç—ã –∫–∞–∫ –∫–æ–º–∞–Ω–¥—ã

```javascript
// –ú–æ—â–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ data-action
const handlers = {
  'load-more': (btn) => {
    const page = parseInt(btn.dataset.page) + 1
    loadPage(page)
  },
  'filter': (btn) => {
    setFilter(btn.dataset.filter)
  },
  'sort': (btn) => {
    setSort(btn.dataset.field, btn.dataset.direction)
  },
  'modal-open': (btn) => {
    openModal(btn.dataset.modal)
  },
}

document.addEventListener('click', (e) => {
  const actionEl = e.target.closest('[data-action]')
  if (!actionEl) return

  const handler = handlers[actionEl.dataset.action]
  if (handler) handler(actionEl)
})
```

## –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º

```javascript
// –°–ø–∏—Å–æ–∫ —Å CRUD ‚Äî –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏
class TodoList {
  #container
  #todos = []
  #nextId = 1

  constructor(container) {
    this.#container = container
    this.#setupDelegation()
  }

  #setupDelegation() {
    this.#container.addEventListener('click', (e) => {
      const id = parseInt(e.target.closest('[data-id]')?.dataset.id)
      if (!id) return

      if (e.target.closest('.delete-btn')) this.delete(id)
      if (e.target.closest('.toggle-btn')) this.toggle(id)
    })
  }

  add(text) {
    const todo = { id: this.#nextId++, text, done: false }
    this.#todos.push(todo)
    this.#render()
    return this
  }

  delete(id) {
    this.#todos = this.#todos.filter(t => t.id !== id)
    this.#render()
  }

  toggle(id) {
    const todo = this.#todos.find(t => t.id === id)
    if (todo) { todo.done = !todo.done; this.#render() }
  }

  #render() {
    this.#container.innerHTML = this.#todos.map(t => `
      <li data-id="${t.id}" style="${t.done ? 'opacity:.5;text-decoration:line-through' : ''}">
        <button class="toggle-btn">‚úì</button>
        ${t.text}
        <button class="delete-btn">‚úï</button>
      </li>
    `).join('')
  }
}

const list = new TodoList(document.querySelector('#todos'))
list.add('–ò–∑—É—á–∏—Ç—å –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ').add('–ü—Ä–∞–∫—Ç–∏–∫–∞').add('–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥')
// –û–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –≤–∫–ª—é—á–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ!
```

## stopPropagation vs preventDefault

```javascript
el.addEventListener('click', (e) => {
  e.stopPropagation()  // ‚úã –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–ø–ª—ã—Ç–∏–µ (–ª–æ–º–∞–µ—Ç –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ!)
  e.preventDefault()   // üö´ –û—Ç–º–µ–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ (—Å—Å—ã–ª–∫–∞, —Ñ–æ—Ä–º–∞)
  e.stopImmediatePropagation() // ‚úã‚úã –¢–∞–∫–∂–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–µ
})

// –ü—Ä–∞–≤–∏–ª–æ: –Ω–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è–π—Ç–µ stopPropagation ‚Äî —ç—Ç–æ –ª–æ–º–∞–µ—Ç –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ!
// –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ e.target –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
```

## –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–∏–º–µ—Ä

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Event Delegation</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <h2>–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π ‚Äî ToDo</h2>
  <div class="add-form">
    <input id="newTask" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞...">
    <button id="addBtn">+ –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
  <ul id="taskList"></ul>
  <p id="stats"></p>
  <script src="/index.js"></script>
</body>
</html>`,
    "/styles.css": `body { font-family: sans-serif; background: #1e1e2e; color: #cdd6f4; padding: 20px; }
h2 { color: #89b4fa; }
.add-form { display: flex; gap: 8px; margin-bottom: 12px; }
input { background: #313244; border: 1px solid #45475a; color: #cdd6f4; padding: 8px 12px; border-radius: 6px; flex: 1; font-size: 15px; }
button { background: #89b4fa; color: #1e1e2e; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: bold; }
ul { list-style: none; padding: 0; }
li { background: #313244; border-radius: 6px; padding: 10px 14px; margin: 6px 0; display: flex; align-items: center; gap: 10px; }
li.done { opacity: 0.5; }
li.done .text { text-decoration: line-through; }
.text { flex: 1; }
.toggle-btn { background: #a6e3a1; width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer; font-size: 16px; }
.delete-btn { background: #f38ba8; color: #1e1e2e; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
#stats { color: #6c7086; font-size: 13px; }`,
    "/index.js": `const list = document.getElementById('taskList')
const input = document.getElementById('newTask')
let nextId = 1
const tasks = []

// ‚úÖ –û–î–ò–ù –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞ ‚Äî –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ!
list.addEventListener('click', (e) => {
  const li = e.target.closest('li')
  if (!li) return
  const id = +li.dataset.id

  if (e.target.closest('.delete-btn')) {
    tasks.splice(tasks.findIndex(t => t.id === id), 1)
    render()
  } else if (e.target.closest('.toggle-btn')) {
    const task = tasks.find(t => t.id === id)
    if (task) { task.done = !task.done; render() }
  }
})

document.getElementById('addBtn').addEventListener('click', addTask)
input.addEventListener('keypress', e => e.key === 'Enter' && addTask())

function addTask() {
  const text = input.value.trim()
  if (!text) return
  tasks.push({ id: nextId++, text, done: false })
  input.value = ''
  render()
}

function render() {
  list.innerHTML = tasks.map(t => \`
    <li data-id="\${t.id}" class="\${t.done ? 'done' : ''}">
      <button class="toggle-btn">\${t.done ? '‚úì' : '‚óã'}</button>
      <span class="text">\${t.text}</span>
      <button class="delete-btn">‚úï</button>
    </li>
  \`).join('')
  const done = tasks.filter(t => t.done).length
  document.getElementById('stats').textContent = 
    \`–í—Å–µ–≥–æ: \${tasks.length} | –í—ã–ø–æ–ª–Ω–µ–Ω–æ: \${done} | –û—Å—Ç–∞–ª–æ—Å—å: \${tasks.length - done}\`
}

// –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
['–ò–∑—É—á–∏—Ç—å Event Delegation', '–ü—Ä–∞–∫—Ç–∏–∫–∞ —Å closest()', '–ù–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ—ë ToDo'].forEach(t => {
  tasks.push({ id: nextId++, text: t, done: false })
})
render()
`
  }}
  options={{ showNavigator: false, showLineNumbers: true, editorHeight: 420 }}
/>
