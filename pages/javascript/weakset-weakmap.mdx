## JavaScript: Мозги. Урок: WeakSet и WeakMap


![Иллюстрация к уроку](/lessons/javascript-weakset-weakmap.png)
WeakSet и WeakMap – это специальные типы коллекций в JavaScript, которые помогают оптимизировать использование памяти, особенно при работе с DOM и другими объектами. Они отличаются от обычных Set и Map тем, что не препятствуют сборщику мусора удалять объекты, на которые они ссылаются.

### Концепция WeakSet

WeakSet – это коллекция, которая может хранить только объекты. В отличие от обычного Set, WeakSet не хранит сильные ссылки на объекты. Это значит, что если объект, находящийся в WeakSet, больше нигде не используется, сборщик мусора может его удалить, даже если он все еще находится в WeakSet.  WeakSet полезен для хранения информации о том, какие объекты, например DOM-элементы, уже обработаны.

Пример:

```javascript
let weakSet = new WeakSet();

let obj1 = {};
let obj2 = {};

weakSet.add(obj1);
weakSet.add(obj2);

console.log(weakSet.has(obj1)); // true

obj1 = null; // obj1 больше не используется

// В какой-то момент сборщик мусора удалит obj1 из WeakSet
// После этого weakSet.has(obj1) вернет false
```

Методы WeakSet:

*   `add(object)`: Добавляет объект в WeakSet.
*   `delete(object)`: Удаляет объект из WeakSet.
*   `has(object)`: Проверяет, есть ли объект в WeakSet.

Важно: WeakSet не поддерживает итерацию (нельзя получить список элементов).

### Концепция WeakMap

WeakMap – это коллекция, которая позволяет связывать объекты с произвольными данными. Как и WeakSet, WeakMap не хранит сильные ссылки на ключи (которые должны быть объектами). Если ключ WeakMap больше нигде не используется, сборщик мусора может его удалить, а вместе с ним и значение, связанное с этим ключом.  WeakMap часто используется для хранения приватных данных объектов.

Пример:

```javascript
let weakMap = new WeakMap();

let obj1 = {};
let obj2 = {};

weakMap.set(obj1, "Информация об obj1");
weakMap.set(obj2, "Информация об obj2");

console.log(weakMap.get(obj1)); // "Информация об obj1"

obj1 = null; // obj1 больше не используется

// В какой-то момент сборщик мусора удалит obj1 из WeakMap
// После этого weakMap.get(obj1) вернет undefined
```

Методы WeakMap:

*   `set(object, value)`: Связывает объект с значением.
*   `get(object)`: Возвращает значение, связанное с объектом.
*   `delete(object)`: Удаляет связь между объектом и значением.
*   `has(object)`: Проверяет, есть ли связь для объекта.

Важно: WeakMap не поддерживает итерацию (нельзя получить список ключей и значений).

### Практический пример

```javascript
// Используем WeakMap для хранения приватных данных объекта

let weakMap = new WeakMap();

class User {
  constructor(name) {
    weakMap.set(this, { name: name, isAdmin: false }); // Храним приватные данные
  }

  getName() {
    return weakMap.get(this).name; // Получаем приватные данные
  }

  setAdmin() {
      weakMap.get(this).isAdmin = true;
  }

  isAdmin() {
    return weakMap.get(this).isAdmin;
  }
}

let user = new User("Иван");
console.log(user.getName()); // Иван
user.setAdmin();
console.log(user.isAdmin()); // true
```

### Жизненный пример

WeakSet и WeakMap часто используются во фреймворках и библиотеках для работы с DOM. Например, они могут применяться для хранения данных, связанных с DOM-элементами, без риска утечек памяти.  Представьте себе систему обработки событий на веб-странице.  Можно использовать WeakMap, чтобы связать каждый DOM-элемент с обработчиками событий, которые к нему привязаны. Когда элемент удаляется из DOM, сборщик мусора сможет его удалить, и связанные с ним обработчики событий будут автоматически освобождены.  Это предотвращает "висячие" обработчики и утечки памяти.

### Ключевые моменты

*   WeakSet и WeakMap хранят только объекты в качестве ключей (WeakSet) или ключей для значений (WeakMap).
*   Они не препятствуют сборщику мусора удалять объекты, на которые они ссылаются.
*   Не поддерживают итерацию.
*   Используются для оптимизации памяти и хранения приватных данных.
*   Полезны при работе с DOM и другими объектами, время жизни которых контролируется не кодом, который их использует.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeakSet и WeakMap</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>WeakSet и WeakMap</h1>

    <div id="weakset-example">
      <h2>WeakSet Пример</h2>
      <button id="add-element">Добавить элемент</button>
      <button id="check-element">Проверить элемент</button>
      <p id="weakset-result"></p>
    </div>

    <div id="weakmap-example">
      <h2>WeakMap Пример</h2>
      <input type="text" id="user-name" placeholder="Имя пользователя">
      <button id="create-user">Создать пользователя</button>
      <button id="get-user-name">Получить имя</button>
      <button id="set-admin">Сделать админом</button>
      <p id="weakmap-result"></p>
    </div>
  </div>

  <script src="/index.js"></script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: 0 auto;
}

h1, h2 {
  color: #ddd;
}

button {
  background-color: #444;
  color: #eee;
  border: none;
  padding: 10px 20px;
  margin: 5px;
  cursor: pointer;
  border-radius: 5px;
}

button:hover {
  background-color: #555;
}

input[type="text"] {
  background-color: #333;
  color: #eee;
  border: none;
  padding: 10px;
  margin: 5px;
  border-radius: 5px;
}

p {
  margin-top: 10px;
}`,
    "/index.js": `// WeakSet Пример
const weakSet = new WeakSet();
let element = document.createElement('div'); // Создаем DOM элемент

document.getElementById('add-element').addEventListener('click', () => {
  weakSet.add(element);
  document.getElementById('weakset-result').textContent = 'Элемент добавлен в WeakSet.';
});

document.getElementById('check-element').addEventListener('click', () => {
  const hasElement = weakSet.has(element);
  document.getElementById('weakset-result').textContent = \`Элемент в WeakSet: \${'}hasElement'}\`;
});

// WeakMap Пример
const weakMap = new WeakMap();

class User {
  constructor(name) {
    weakMap.set(this, { name: name, isAdmin: false });
  }

  getName() {
    return weakMap.get(this).name;
  }

  setAdmin() {
    weakMap.get(this).isAdmin = true;
  }

  isAdmin() {
    return weakMap.get(this).isAdmin;
  }
}

let user; // Объявляем переменную user

document.getElementById('create-user').addEventListener('click', () => {
  const userName = document.getElementById('user-name').value;
  user = new User(userName); // Создаем экземпляр User
  document.getElementById('weakmap-result').textContent = 'Пользователь создан.';
});

document.getElementById('get-user-name').addEventListener('click', () => {
  if (user) {
    const name = user.getName();
    document.getElementById('weakmap-result').textContent = \`Имя пользователя: \${'}name'}\`;
  } else {
    document.getElementById('weakmap-result').textContent = 'Сначала создайте пользователя.';
  }
});

document.getElementById('set-admin').addEventListener('click', () => {
  if (user) {
    user.setAdmin();
    document.getElementById('weakmap-result').textContent = 'Пользователь стал админом.';
  } else {
    document.getElementById('weakmap-result').textContent = 'Сначала создайте пользователя.';
  }
});`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
