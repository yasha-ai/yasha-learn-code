## JavaScript: Мозги. IndexedDB


![Иллюстрация к уроку](/lessons/javascript-indexeddb.png)
IndexedDB - это мощный инструмент для хранения структурированных данных в браузере. Он позволяет создавать базы данных прямо в браузере пользователя, обеспечивая офлайн-доступ и более быструю загрузку данных.

### Что такое IndexedDB?

IndexedDB - это NoSQL база данных, встроенная в браузер.  Она работает асинхронно и использует транзакции для обеспечения целостности данных.  В отличие от cookies или localStorage, IndexedDB может хранить гораздо большие объемы данных и обладает более развитыми возможностями индексации и поиска.

### Основы работы с IndexedDB

Давайте рассмотрим основные шаги работы с IndexedDB на примере:

1.  **Открытие базы данных:**

```javascript
let db;
const dbName = "myDatabase";
const dbVersion = 1;

const request = indexedDB.open(dbName, dbVersion);

request.onerror = function(event) {
  console.log("Ошибка открытия базы данных: " + event.target.errorCode);
};

request.onsuccess = function(event) {
  db = event.target.result;
  console.log("База данных успешно открыта");
  // Здесь можно выполнять операции с базой данных
};

request.onupgradeneeded = function(event) {
  db = event.target.result;

  // Создаем хранилище объектов (object store)
  const objectStore = db.createObjectStore("myObjectStore", { keyPath: "id", autoIncrement: true });

  // Создаем индекс для поиска по полю "name"
  objectStore.createIndex("name", "name", { unique: false });

  console.log("База данных обновлена или создана");
};
```

2.  **Добавление данных:**

```javascript
function addData(data) {
  const transaction = db.transaction(["myObjectStore"], "readwrite");
  const objectStore = transaction.objectStore("myObjectStore");
  const request = objectStore.add(data);

  request.onsuccess = function(event) {
    console.log("Данные успешно добавлены: " + event.target.result);
  };

  request.onerror = function(event) {
    console.log("Ошибка добавления данных: " + event.target.errorCode);
  };
}

// Пример добавления данных
const newData = { name: "John Doe", age: 30 };
addData(newData);
```

3.  **Получение данных:**

```javascript
function getData(id) {
  const transaction = db.transaction(["myObjectStore"], "readonly");
  const objectStore = transaction.objectStore("myObjectStore");
  const request = objectStore.get(id);

  request.onsuccess = function(event) {
    const data = event.target.result;
    if (data) {
      console.log("Полученные данные: ", data);
    } else {
      console.log("Данные с id " + id + " не найдены");
    }
  };

  request.onerror = function(event) {
    console.log("Ошибка получения данных: " + event.target.errorCode);
  };
}

// Пример получения данных
getData(1);
```

4.  **Удаление данных:**

```javascript
function deleteData(id) {
  const transaction = db.transaction(["myObjectStore"], "readwrite");
  const objectStore = transaction.objectStore("myObjectStore");
  const request = objectStore.delete(id);

  request.onsuccess = function(event) {
    console.log("Данные с id " + id + " успешно удалены");
  };

  request.onerror = function(event) {
    console.log("Ошибка удаления данных: " + event.target.errorCode);
  };
}

// Пример удаления данных
deleteData(1);
```

### Жизненный пример

IndexedDB широко используется в веб-приложениях, требующих офлайн-доступ к данным или кэширование больших объемов информации. Например:

*   **Офлайн-приложения:**  Приложения для заметок, редакторы текста, приложения для чтения, которые позволяют пользователям работать без подключения к интернету.
*   **Кэширование данных:**  Кэширование изображений, видео и других ресурсов для ускорения загрузки веб-страниц.
*   **Progressive Web Apps (PWA):**  IndexedDB часто используется в PWA для хранения данных и обеспечения офлайн-функциональности.
*   **Фреймворки:** Многие современные JavaScript фреймворки и библиотеки (например, React, Angular, Vue.js) предоставляют абстракции над IndexedDB для упрощения работы с ней.

### Ключевые моменты

*   IndexedDB - это NoSQL база данных в браузере.
*   Работает асинхронно и использует транзакции.
*   Позволяет хранить большие объемы данных.
*   Используется для офлайн-доступа и кэширования.
*   Важно правильно обрабатывать ошибки и обновления схемы базы данных.



## Интерактивный пример

<Sandpack
  template="vanilla"
  files={{
    "/index.html": `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IndexedDB Example</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <h1>IndexedDB Demo</h1>

  <div class="container">
    <label for="name">Имя:</label>
    <input type="text" id="name" placeholder="Введите имя">

    <label for="age">Возраст:</label>
    <input type="number" id="age" placeholder="Введите возраст">

    <button id="addButton">Добавить данные</button>
    <button id="getDataButton">Получить данные (id: 1)</button>
    <button id="deleteButton">Удалить данные (id: 1)</button>

    <div id="output"></div>
  </div>

  <script src="/index.js"></script>
</body>
</html>`,
    "/styles.css": `body {
  font-family: sans-serif;
  background-color: #222;
  color: #eee;
  padding: 20px;
}

.container {
  max-width: 600px;
  margin: 0 auto;
}

label {
  display: block;
  margin-bottom: 5px;
}

input[type="text"],
input[type="number"] {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
  border: 1px solid #555;
  background-color: #333;
  color: #eee;
}

button {
  padding: 10px 15px;
  background-color: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
  margin-right: 10px;
}

button:hover {
  background-color: #3e8e41;
}

#output {
  margin-top: 20px;
  padding: 10px;
  border: 1px solid #555;
  background-color: #333;
  color: #eee;
}`,
    "/index.js": `// Инициализация IndexedDB
let db;
const dbName = "myDatabase";
const dbVersion = 1;

const request = indexedDB.open(dbName, dbVersion);

request.onerror = function(event) {
  console.log("Ошибка открытия базы данных: " + event.target.errorCode);
  document.getElementById("output").innerText = "Ошибка: " + event.target.errorCode;
};

request.onsuccess = function(event) {
  db = event.target.result;
  console.log("База данных успешно открыта");
  document.getElementById("output").innerText = "База данных успешно открыта";

  // Добавляем обработчики событий после успешного открытия БД
  document.getElementById("addButton").addEventListener("click", addData);
  document.getElementById("getDataButton").addEventListener("click", getData);
  document.getElementById("deleteButton").addEventListener("click", deleteData);
};

request.onupgradeneeded = function(event) {
  db = event.target.result;

  // Создаем хранилище объектов (object store)
  const objectStore = db.createObjectStore("myObjectStore", { keyPath: "id", autoIncrement: true });

  // Создаем индекс для поиска по полю "name"
  objectStore.createIndex("name", "name", { unique: false });

  console.log("База данных обновлена или создана");
  document.getElementById("output").innerText = "База данных обновлена или создана";
};

// Функция для добавления данных
function addData() {
  const name = document.getElementById("name").value;
  const age = document.getElementById("age").value;

  if (!name || !age) {
    alert("Пожалуйста, заполните все поля.");
    return;
  }

  const transaction = db.transaction(["myObjectStore"], "readwrite");
  const objectStore = transaction.objectStore("myObjectStore");
  const request = objectStore.add({ name: name, age: parseInt(age) });

  request.onsuccess = function(event) {
    console.log("Данные успешно добавлены: " + event.target.result);
    document.getElementById("output").innerText = "Данные успешно добавлены. ID: " + event.target.result;
    document.getElementById("name").value = "";
    document.getElementById("age").value = "";
  };

  request.onerror = function(event) {
    console.log("Ошибка добавления данных: " + event.target.errorCode);
    document.getElementById("output").innerText = "Ошибка добавления данных: " + event.target.errorCode;
  };
}

// Функция для получения данных
function getData() {
  const transaction = db.transaction(["myObjectStore"], "readonly");
  const objectStore = transaction.objectStore("myObjectStore");
  const request = objectStore.get(1); // Получаем данные с id 1

  request.onsuccess = function(event) {
    const data = event.target.result;
    if (data) {
      console.log("Полученные данные: ", data);
      document.getElementById("output").innerText = "Полученные данные: Имя: " + data.name + ", Возраст: " + data.age;
    } else {
      console.log("Данные с id 1 не найдены");
      document.getElementById("output").innerText = "Данные с id 1 не найдены";
    }
  };

  request.onerror = function(event) {
    console.log("Ошибка получения данных: " + event.target.errorCode);
    document.getElementById("output").innerText = "Ошибка получения данных: " + event.target.errorCode;
  };
}

// Функция для удаления данных
function deleteData() {
  const transaction = db.transaction(["myObjectStore"], "readwrite");
  const objectStore = transaction.objectStore("myObjectStore");
  const request = objectStore.delete(1); // Удаляем данные с id 1

  request.onsuccess = function(event) {
    console.log("Данные успешно удалены");
    document.getElementById("output").innerText = "Данные успешно удалены";
  };

  request.onerror = function(event) {
    console.log("Ошибка удаления данных: " + event.target.errorCode);
    document.getElementById("output").innerText = "Ошибка удаления данных: " + event.target.errorCode;
  };
}
`
  }}
  options={{
    showNavigator: false,
    showLineNumbers: true,
    editorHeight: 400
  }}
/>
